import collections
import glob
import hashlib
import pickle
import re
import threading
import time
from datetime import datetime
from random import randrange

import telepot
import urllib3
from flask import Flask, request
from pytz import timezone
from telegram import ReplyKeyboardMarkup, ReplyKeyboardRemove, InlineKeyboardButton, InlineKeyboardMarkup
from telepot.namedtuple import ReplyKeyboardMarkup, ReplyKeyboardRemove, InlineKeyboardMarkup, \
    InlineKeyboardButton

# ×˜×•×§×Ÿ ×–×™×”×•×™ ×™×™×—×•×“×™ ×œ×‘×•×˜. ××©××© ×’× ×›×“×™ ×œ××‘×˜×— ××ª ×”× ×ª×•× ×™ ×›× ×™×¡×” (×›××• ×¡×™×¡××).
BOT_TOKEN = "923788458:AAEU7AkkMCCfemmRRn4uxIjgxhdTn7FIUuM"

# ×ª×§×™×™×™×ª ×”×©×•×¨×© ×©×œ ×”×¤×¨×•×™×™×§×˜, ×¢× ×”×§×‘×¦×™× ×”×‘×¡×™×¡×™×™×.
ROOT_PATH = "/home/elikopeleg/"

# × ×ª×™×‘ ×œ×§×•×‘×¥ ×˜×§×¡×˜ ×©×©×•××¨ ××ª ×”-ID ×©×œ ×›×œ ×”×¦'××˜×™× ×¢× ×”××©×ª××©×™×. ××©××© ×›×“×™ ×œ×©×œ×•×— ×œ×”× ×”×•×“×¢×” (×œ×“×¢×ª ××™ ××©×ª××©) ×•×›×“×™ ×œ×¡×¤×•×¨ ×›××” ××©×ª××©×™× ×™×©.
USERS_PATH = f'{ROOT_PATH}/users-1.txt'

# × ×ª×™×‘ ×œ×§×‘×¦×™ ×”××§×•×¨×“×™× ×©×”×•×¢×œ×• ×›×‘×¨ ×œ×¢×¨×•×¥ (×‘×¢×™×§×¨×•×Ÿ ×›×•×œ× ×—×•×¥ ×××œ×• ×©×¢×•×“×›× ×• ×œ××—×©×‘ ×”××§×•××™ ×©×œ ×”×× ×”×œ ×•×¢×•×“ ×œ× ×”×•×¢×œ×• ×œ×¢×¨×•×¥).
UPLOADED_PATH = ROOT_PATH + "/uploaded/"

# ×¨×©×™××ª ×©××•×ª ×”×§×‘×¦×™× (×”×©×™×¨×™×) ×©×§×™×™××™×. × ×©××¨ ×¤×¢× ××—×ª ××˜×¢××™ ××•×¤×˜×™××–×¦×™×”. ××—×¨×™ ×¢×“×›×•×Ÿ, ×”×‘×•×˜ ××•×¨×¥ ××—×“×© ×¢"×™ ×¡×§×¨×™×¤×˜ ×”×¢×“×›×•×Ÿ ×•×›×š ××¢×“×›×Ÿ ××ª ×¨×©×™××ª ×”×§×‘×¦×™×.
UPLOADED_LIST = glob.glob(f"{UPLOADED_PATH}/*")

# ××•×¨×š ×”× ×ª×™×‘ × ×©××¨ ××˜×¢××™ ××•×¤×˜×™××–×¦×™×”. ××—×•×©×‘ ×¨×§ ×¤×” ×‘××§×•× ×©×•×‘ ×•×©×•×‘. ××©××© ×›×“×™ ×œ×—×ª×•×š × ×ª×™×‘ ×œ×§×•×‘×¥ ××§×•×¨×“×™× ×•×œ×§×‘×œ ×¨×§ ××ª ×”×©× ×©×œ ×”×§×•×‘×¥.
LEN_UPLOADED_PATH = len(UPLOADED_PATH)

# ×›×œ ×”××§×•×¨×“×™× ×©×™×© ×œ×”× ×ª××•× ×”.
CHORDS_LIBRARY = ["A", "A5", "A6", "A7", "A9", "A_Ab", "A_B", "A_Bb", "A_C#", "A_C", "A_D", "A_E", "A_Eb", "A_F#",
                  "A_F", "A_G", "Aadd9", "Aaug", "Ab", "Ab5", "Ab6", "Ab7", "Ab9", "Ab_A", "Ab_Bb", "Ab_C#", "Ab_C",
                  "Ab_Eb", "Ab_F#", "Ab_G", "Abadd9", "Abaug", "Abdim", "Abdim7", "Abm", "Abm7", "Abm7b5", "Abm9",
                  "Abmaj7", "Absus4", "Adim", "Adim7", "Am", "Am7", "Am7b5", "Am9", "Am_Ab", "Am_B", "Am_Bb", "Am_C",
                  "Am_D", "Am_E", "Am_Eb", "Am_F#", "Am_F", "Am_G", "Amaj7", "Ammaj7", "Asus4", "B", "B5_", "B6", "B7",
                  "B9_2", "B_A", "B_Ab", "Badd9", "Baug", "Bb", "Bb5", "Bb6", "Bb7", "Bb9", "Bb9_2", "Bb_A", "Bb_Ab",
                  "Bb_B", "Bb_Eb", "Bbadd9", "Bbaug", "Bbdim", "Bbdim7", "Bbm", "Bbm7", "Bbm7b5", "Bbm9", "Bbmaj7",
                  "Bbsus4", "Bdim", "Bdim7", "Bm", "Bm7", "Bm7b5", "Bm9", "Bm_A", "Bm_Ab", "Bm_Bb", "Bm_C#", "Bm_C",
                  "Bm_F#", "Bmaj7", "Bsus4", "C#", "C#5", "C#6", "C#7", "C#9_2", "C#add9", "C#aug", "C#dim", "C#dim7",
                  "C#m", "C#m7", "C#m7b5", "C#m9", "C#maj7", "C#mmaj7", "C#sus4", "C", "C5", "C6", "C7", "C9_2", "C_A",
                  "C_B", "C_Bb", "C_C#", "C_G", "Cadd9", "Caug", "Cdim", "Cdim7", "Cm", "Cm7", "Cm7b5", "Cm9", "Cmaj7",
                  "Csus4", "D", "D5", "D6", "D7", "D9", "D_A", "D_B", "D_Bb", "D_C#", "D_C", "D_F#", "Dadd9", "Daug",
                  "Ddim", "Ddim7", "Dm", "Dm7", "Dm7b5", "Dm9", "Dm_A", "Dm_B", "Dm_C", "Dmaj7", "Dsus4", "E", "E5",
                  "E6", "E7", "E9", "E_A", "E_Ab", "E_B", "E_Bb", "E_C#", "E_C", "E_D", "E_Eb", "E_F#", "E_F", "E_G",
                  "Eadd9", "Eaug", "Eb", "Eb5", "Eb6", "Eb7", "Eb9", "Eb9_2", "Ebadd9", "Ebaug", "Ebdim", "Ebdim7",
                  "Ebm", "Ebm7", "Ebm7b5", "Ebm9", "Ebmaj7", "Ebsus4", "Edim", "Edim7", "Em", "Em7", "Em7b5", "Em9",
                  "Em_A", "Em_Ab", "Em_B", "Em_Bb", "Em_C#", "Em_C", "Em_D", "Em_Eb", "Em_F#", "Em_F", "Em_G", "Emaj7",
                  "Esus4", "F#", "F#5", "F#6", "F#7", "F#9", "F#_Ab", "F#_B", "F#_Bb", "F#_C#", "F#_E", "F#_F", "F#_G",
                  "F#add9", "F#aug", "F#dim", "F#dim7", "F#m", "F#m7", "F#m7b5", "F#m9", "F#m_E", "F#m_F", "F#m_G",
                  "F#maj7", "F#sus4", "F", "F5", "F6", "F7", "F9_2", "F_A", "F_Bb", "F_C", "F_D", "F_E", "F_Eb", "F_F#",
                  "F_G", "Fadd9", "Faug", "Fdim", "Fdim7", "Fm", "Fm7", "Fm7b5", "Fm9", "Fm_Ab", "Fm_D", "Fm_E",
                  "Fm_Eb", "Fm_F#", "Fmaj7", "Fsus4", "G", "G5", "G6", "G7", "G9", "G_C", "G_D", "G_E", "G_F#", "G_F",
                  "Gadd9", "Gaug", "Gdim", "Gdim7", "Gm", "Gm7", "Gm7b5", "Gm9", "Gm_Ab", "Gm_D", "Gm_E", "Gm_F",
                  "Gmaj7", "Gsus4"]

# ×¨×©×™××” ××™×•×—×“×ª. ×›×œ ×”××§×•×¨×“×™× ×”×‘×¡×™×¡×™×™×, ××‘×œ ×§×•×“× ××œ×• ×¢× # ××• b.
# × ×•×¢×“ ×œ×”××¨×•×ª. ×× ×”×•×¤×›×™× ××ª ×›×œ ×” F ×œ×”×™×•×ª G ×•×¨×§ ××– ××—×¤×©×™× F#, ×™×”×™×” ×‘××§×•× F# G#.
# ×‘×¨×©×™××” ×”×–×• ×§×•×“× F# ××•×—×œ×£ ×‘A# ×•×¨×§ ××– ××—×¤×©×™× F.
CHORDS = ["A#", "Ab", "A", "Bb", "B", "C#", "C", "Db", "D#", "D", "Eb", "E", "F#", "F", "Gb", "G#", "G"]

# ××©××© ×œ×”××¨×ª ×¡×•×œ××•×ª. ×”××§×•×¨×“×™× ×‘××¨×•×•×—×™× ×©×œ ×—×¦×™ ×‘×“×™×•×§.
LEVELS = [["A", "A#", "B", "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#"],
          ["Ab", "A", "Bb", "B", "C", "Db", "D", "Eb", "E", "F", "Gb", "G"]]

# ×”×©×™×¨×™× × ×©××¨×™× ×‘×œ×™ ×”×¤×ª×™×—×” ×•×”×¡×™×•× (×©×•×¨×•×ª ××™×•×—×“×•×ª ×¢× ×××•×’'×™× ×•×§×™×©×•×¨ ×œ×¢×¨×•×¥ ××• ×œ×¨×•×‘×•×˜).
# ×›×“×™ ×œ×—×¡×•×š ×¤×ª×™×—×” ××—×“×© ×©×œ ×”×§×•×‘×¥ ×©×©×•××¨ ××ª × ×ª×•× ×™ ×”×¤×ª×™×—×” ×•×”×¡×™×•× (×”× ×§×‘×•×¢×™×), ×”×¤×ª×™×—×” ×•×”×¡×™×•× ×©×œ ×”×”×•×“×¢×•×ª × ×©××¨×™× ×‘×§×‘×•×¢×™×.
fname = f"{ROOT_PATH}/message-intro.txt"
with open(fname, "r") as f:
    # ×©×•××¨ ××ª ×”×¤×ª×™×—×” ×”×§×‘×•×¢×” ×œ×ª×•×š INTRO
    INTRO = f.read()

fname = f"{ROOT_PATH}/message-end.txt"
with open(fname, "r") as f:
    # ×‘×§×•×‘×¥ ×¡×™×•× ×™×© ×§×™×©×•×¨ ×œ×¢×¨×•×¥ ×©×œ ×”××§×•×¨×“×™×. ×‘×’×œ×œ ×©×”×‘×•×˜ ×”×•× ×–×” ×©×©×œ×— ××ª ×”×”×•×“×¢×” ×•×œ× ×”×¢×¨×•×¥, ×”×§×™×©×•×¨ ×‘×¡×•×£ ××©×ª× ×” ×œ×§×™×©×•×¨ ×œ×‘×•×˜ ×•×œ× ×œ×¢×¨×•×¥.
    ENDING = f.read().replace("â€@Tab4us", "â€@Tab4usBot")

# ××¢×ª×™×§ ××ª ×¨×©×™××ª ×”××©×ª××©×™× ××”×§×•×‘×¥, ×›×“×™ ×œ×‘×“×•×§ ×× ××“×•×‘×¨ ×‘××©×ª××© ×—×“×©.
# !!! ×¦×¨×™×š ×œ××¦×•× ×“×¨×š ×™×¢×™×œ×” ×›×“×™ ×œ×× ×•×¢ re-reading ×©×œ ×”× ×ª×•× ×™× ×‘×›×œ ×”×¨×¦×”.
with open(USERS_PATH, 'r') as f:
    USERS = f.read().split('\n')

# × ×ª×™×‘ ×”×§×•×‘×¥ ×©×©×•××¨ ××ª ×”×¡×˜×˜×™×¡×˜×™×§×”. ×–×”×• ×§×•×‘×¥ ×©×©×•××¨ "××™×œ×•×Ÿ". ×”××™×œ×•×Ÿ ××‘×˜×: ×›××” ×¤×¢××™× ×—×™×¤×©×•,×¢×œ ×¤×™ ××” ×—×™×¤×©×•.
STATISTICS_PATH = f'{ROOT_PATH}/statistics-1.pkl'

# ×§×•×¨× ××ª ×”×¡×˜×˜×™×¡×˜×™×§×” ×œ×ª×•×š ×”××™×œ×•×Ÿ. ×× ×”×§×•×‘×¥ ×œ× ×§×™×™× ××• ×¨×™×§, ×™×•×¦×¨ ××•×ª×•.
try:

    # ×§×•×¨× ××ª ×”× ×ª×•× ×™× ××”×§×•×‘×¥ ×œ×ª×•×š statistics.
    with open(STATISTICS_PATH, 'rb') as fp:
        statistics = pickle.load(fp)

# ×× ×”××•×¨×š ×©×œ ×”×§×•×‘×¥ ×™×”×™×” 0, ×ª×•×—×–×¨ ×©×’×™××” EOFError.
# ×× ×”×§×•×‘×¥ ×œ× ×§×™×™×, ×ª×•×—×–×¨ ×©×’×™××” FileNotFoundError.
# ×‘×›×œ ××§×¨×”, ×”×¤×ª×¨×•×Ÿ ×”×•× ×œ×™×¦×•×¨ ××ª ×”×§×•×‘×¥ ××—×“×©.
except (FileNotFoundError, EOFError) as e:

    # ×™×•×¦×¨ ××ª ×”×§×•×‘×¥, ×•××›× ×™×¡ ×œ×ª×•×›×• ××™×œ×•×Ÿ ×¨×™×§.
    with open(STATISTICS_PATH, 'wb') as fp:

        # ××›× ×™×¡ ××™×œ×•×Ÿ ×¨×™×§({}) ×œ×ª×•×š ×”×§×•×‘×¥, ×›×“×™ ×©×œ× ×™×”×™×” ×¢× ××•×¨×š 0.
        pickle.dump({}, fp, protocol=pickle.HIGHEST_PROTOCOL)

        # ×™×•×¦×¨ ××ª ×”××™×œ×•×Ÿ ×©×œ ×”×¡×˜×˜×™×¡×˜×™×§×” (××©×ª× ×” ××§×•××™ statistics) ×¨×™×§.
        statistics = collections.OrderedDict()

# ×“×’×œ ×©×‘×•×“×§ ×”×× ×”×§×™×©×•×¨ ×‘×§×‘×•×¦×” ×©×•××©. ×× ×›×Ÿ, ×”×‘×•×˜ ×™××—×§ ××ª ×”×”×•×“×¢×•×ª.
# × ×‘×“×§ ×¤×¢× ×‘5 ×“×§×•×ª. ××—×¨×™ 3 ×©×¢×•×ª ×™×™××—×§ ×‘×›×œ ××§×¨×” (×œ×× ×•×¢ ×¢×‘×•×“×” ××™×•×ª×¨×ª ×©×œ ×”×‘×•×˜)
flags = {}

# ×”×ª×•×¦××•×ª ×—×™×¤×•×© ×©×œ ×”×”×•×“×¢×” ×‘×§×‘×•×¦×”.
# ×œ×“×•×’×× - ××©×ª××© ×©×œ×— ×‘×§×‘×•×¦×” "××§×•×¨×“×™× ×œ××™×™×œ ×’×•×œ×Ÿ", ×‘×ª×•×š ×”-saved ×™×™×©××¨×• ×”×ª×•×¦××•×ª ×œ×—×™×¤×•×© "××™×™×œ ×’×•×œ×Ÿ", ×›×š ×©×”×Ÿ ×™×•×¦×’×• ×œ××©×ª××© ××™×™×“ ×œ××—×¨ ×”×œ×—×™×¦×” ×¢×œ ×”×§×™×©×•×¨ ×œ×¨×•×‘×•×˜.
saved = {}

# ×”××–×”×” ×”×™×™×—×•×“×™ ×©×œ ×”×”×•×“×¢×•×ª ×‘×§×‘×•×¦×”.
# ×”××–×”×” ×©×œ ×”×•×“×¢×ª ×‘×§×©×ª ××§×•×¨×“×™× ×•×ª×’×•×‘×ª ×”×‘×•×˜ × ×©××¨ ×›×“×™ ×œ××—×•×§ ××ª ×”×”×•×“×¢×•×ª ××—×¨×™ ×©×”×§×™×©×•×¨ × ×œ×—×¥ (××•× ×¢ ×”×¡×¤××” ×¢"×™ ×”×‘×•×˜).
to_delete = {}

# ×›×“×™ ×©×™×”×™×” ××¤×©×¨ ×œ×’×©×ª ××”×©×¨×ª ×œ×˜×œ×’×¨× ×¦×¨×™×š ×œ×”×©×ª××© ×‘×¤×¨×•×§×¡×™ ××•×‘× ×”.
# ×”×›×ª×•×‘×ª ×©×œ ×”×¤×¨×•×§×¡×™.
PROXY_URL = "http://proxy.server:3128"

# ××’×“×™×¨ ××ª ×”×¤×¨×•×§×¡×™ ×œ×¨×•×‘×•×˜.
telepot.api._pools = {
    'default': urllib3.ProxyManager(proxy_url=PROXY_URL, num_pools=3, maxsize=10, retries=False, timeout=30),
}
telepot.api._onetime_pool_spec = (
    urllib3.ProxyManager, dict(proxy_url=PROXY_URL, num_pools=1, maxsize=1, retries=False, timeout=30))

# ××’×“×™×¨ ××ª ×”×¨×•×‘×•×˜ ×¢×¤ ×”×˜×•×§×Ÿ ×”×™×™×—×•×“×™ ×©×œ×• ×•××–×“×”×” ××•×œ ×˜×œ×’×¨×.
bot = telepot.Bot(BOT_TOKEN)

# ××‘×§×© ××˜×œ×’×¨× ×œ×©×œ×•×— ××ª ×›×œ ×”×¢×“×›×•× ×™× ×‘×ª×•×¨ POST ×œ×›×ª×•×‘×ª ×”×–×•.
# ×”×›×ª×•×‘×ª ××•×¨×›×‘×ª ××›×ª×•×‘×ª ×”×‘×¡×™×¡, ×¤×œ×•×¡ ×”×˜×•×§×Ÿ. ×‘×¦×•×¨×” ×›×–×• ×¨×§ ××™ ×©×™×© ×œ×• ××ª ×”×˜×•×§×Ÿ ×™×›×•×œ ×œ×’×©×ª ×œ××ª×¨ (××™ ××¤×©×¨ "×œ×’× ×•×‘" ××ª ×”×‘×•×˜).
bot.setWebhook(f"https://elikopeleg.pythonanywhere.com/{BOT_TOKEN}")

# ××’×“×™×¨×™× ××©×™××ª Flask ×—×“×©×” ×©×˜×˜×¤×œ ×‘×¢×“×›×•× ×™×.
app = Flask(__name__)

# "××§×œ×“×ª" ×¢× ××•×¤×¦×™×” ××—×ª - ×©×œ×— ×œ×™ ×©×™×¨ ××§×¨××™.
random_keyboard = ReplyKeyboardMarkup(keyboard=[['×©×™×¨ ××§×¨××™']], resize_keyboard=True, one_time_keyboard=True,
                                      hide_keyboard=True)


# ××§×œ×“×ª ×©× ×©×œ×—×ª ×œ××—×¨ ×œ×—×™×¦×” ×¢×œ "+" ×‘××§×œ×“×ª ×”×§×•×“××ª. ××¨××” ××ª ××•×¤×¦×™×•×ª ×”×©×™× ×•×™.
# ×”×©×™××•×© ×‘×¤×•× ×§×¦×™×” × ×•×¢×“ ×›×“×™ ×œ×”×›× ×™×¡ ××ª ×”××™× ×“×§×¡ ×©×œ ×”×©×™×¨ (××™×¤×” ×”×•× ×××•×§× ×‘×ª×•×š uploaded_list - ×•×‘×”××¨×” ×™×”×™×” ××¤×©×¨ ×œ×©×œ×•×£ ××•×ª×• ×‘×§×œ×•×ª.
def keyboard_plus(index):
    return InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="+1", callback_data=f'+1|{index}'),
                                                  InlineKeyboardButton(text="+2", callback_data=f'+2|{index}'),
                                                  InlineKeyboardButton(text="+3", callback_data=f'+3|{index}')],
                                                 [InlineKeyboardButton(text="+0.5", callback_data=f'+0.5|{index}'),
                                                  InlineKeyboardButton(text="+1.5", callback_data=f'+1.5|{index}'),
                                                  InlineKeyboardButton(text="+2.5", callback_data=f'+2.5|{index}'),
                                                  InlineKeyboardButton(text="+3.5", callback_data=f'+3.5|{index}')]
                                                 ])


# ××§×œ×“×ª ×©× ×©×œ×—×ª ×œ××—×¨ ×œ×—×™×¦×” ×¢×œ "-" ×‘××§×œ×“×ª ×”×§×•×“××ª. ××¨××” ××ª ××•×¤×¦×™×•×ª ×”×©×™× ×•×™.
# ×”×©×™××•×© ×‘×¤×•× ×§×¦×™×” × ×•×¢×“ ×›×“×™ ×œ×”×›× ×™×¡ ××ª ×”××™× ×“×§×¡ ×©×œ ×”×©×™×¨ (××™×¤×” ×”×•× ×××•×§× ×‘×ª×•×š uploaded_list - ×•×‘×”××¨×” ×™×”×™×” ××¤×©×¨ ×œ×©×œ×•×£ ××•×ª×• ×‘×§×œ×•×ª.
def keyboard_minus(index):
    return InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="-1", callback_data=f'-1|{index}'),
                                                  InlineKeyboardButton(text="-2", callback_data=f'-2|{index}'),
                                                  InlineKeyboardButton(text="-3", callback_data=f'-3|{index}')],
                                                 [InlineKeyboardButton(text="-0.5", callback_data=f'-0.5|{index}'),
                                                  InlineKeyboardButton(text="-1.5", callback_data=f'-1.5|{index}'),
                                                  InlineKeyboardButton(text="-2.5", callback_data=f'-2.5|{index}'),
                                                  InlineKeyboardButton(text="-3.5", callback_data=f'-3.5|{index}')]
                                                 ])


# ××§×œ×“×ª ×”××¨×•×ª ×”××§×•×¨×“×™×. ×××¤×©×¨×ª ×œ×”×¢×œ×•×ª ××• ×œ×”×•×¨×™×“ ×¡×•×œ×.
# ×”×©×™××•×© ×‘×¤×•× ×§×¦×™×” × ×•×¢×“ ×›×“×™ ×œ×”×›× ×™×¡ ××ª ×”××™× ×“×§×¡ ×©×œ ×”×©×™×¨ (××™×¤×” ×”×•× ×××•×§× ×‘×ª×•×š uploaded_list) - ×•×‘×”××¨×” ×™×”×™×” ××¤×©×¨ ×œ×©×œ×•×£ ××•×ª×• ×‘×§×œ×•×ª.
def default_keyboard(index, easy_key):
    # ×× ××™×Ÿ ×’×¨×¡×” ×§×œ×”..
    if not easy_key:
        # ××—×–×™×¨ ××§×œ×“×ª ×¨×§ ×¢× "+" "-".
        return InlineKeyboardMarkup(
            inline_keyboard=[[InlineKeyboardButton(text="+", callback_data=f"+|{index}"),
                              InlineKeyboardButton(text="-", callback_data=f"-|{index}")]
                             ])

    # ×× ×”×¡×•×œ× ×”×§×œ ×œ× ×©×œ×™×œ×™, ×¦×¨×™×š ×œ×”×•×¡×™×£ ×œ×¤× ×™×• ×¡×™××Ÿ ×©×œ "+" ×›×“×™ ×œ×”×ª××™× ×œ×¤×•×¨××˜.
    if float(easy_key) >= 0:
        easy_key = f"+{easy_key}"

    # ××—×–×™×¨ ××§×œ×“×ª ×¢× "+" "-" "×’×¨×¡×” ×§×œ×”"
    return InlineKeyboardMarkup(
        inline_keyboard=[[InlineKeyboardButton(text="+", callback_data=f"+|{index}"),
                          InlineKeyboardButton(text="-", callback_data=f"-|{index}")],
                         [InlineKeyboardButton(text="×’×¨×¡×” ×§×œ×”", callback_data=f"{easy_key}|{index}")]
                         ])


# ×”×¤×•× ×§×¦×™×” ×‘×•×“×§×ª ×× ×”×©× ×©×œ ×”×–××¨ ××• ×”×©×™×¨ ××•×¨×›×‘ ×¨×§ ×××•×ª×™×•×ª ×’×“×•×œ×•×ª.
# ×× ×›×Ÿ, ×¦×¨×™×š ×œ×“×œ×’ ×¢×œ ×¤×•× ×§×¦×™×™×ª ×” title.
def is_upper(i):
    # ×× ×”×©× ××•×¨×›×‘ ×¨×§ ×××•×ª×™×•×ª ×’×“×•×œ×•×ª, ×”×•× ××•×—×–×¨ ×›××• ×©×”×•×.
    if i.isupper():
        return i
    # ×× ×œ×, ××¡×“×¨×™× ××ª ×”×©× ×¢× title.
    else:
        return i.title()


# ××§×‘×œ ×§×™×©×•×¨ ××œ× ×œ×§×•×‘×¥ ×‘×ª×§×™×™×ª uploaded, ×•××¡×™×¨ ××× ×• ××ª ×”×¡×™×•××ª ".TXT" ×•××ª ×”×§×™×“×•××ª ×©×œ "\home\elikoeleg" ×•×›×•'.
def replace_to_filename(i):
    return i[LEN_UPLOADED_PATH:-4]


# ×”×¤×•× ×§×¦×™×” ××©××©×ª ×›×“×™ ×œ×”×’×“×™×¨ ×‘×¢×–×¨×ª×” ××ª ×¨×©×™××ª ×”××× ×™×.
# ×”×™× ××§×‘×œ×ª × ×ª×™×‘ ××œ× ×œ×§×•×‘×¥, ×•××—×–×™×¨×” ××ª ×©× ×”×××Ÿ.
# ×”×©×™××•×© ×‘×¤×•× ×§×¦×™×” × ×•×¢×“ ×¢×‘×•×¨ map - ×—×¡×›×•× ×™ ×™×•×ª×¨ ××œ×•×œ××ª for.
def get_artist(name):
    return replace_to_filename(name).split(" - ")[0]


# ×©×•××¨ ×¨×©×™××” ×©×œ ×›×œ ×”××× ×™×.
# ×”×©×™××•×© ×‘ map × ×•×¢×“ ×›×“×™ ×œ×—×¡×•×š ×œ×•×œ××ª for (×™×¢×™×œ ×™×•×ª×¨).
ARTISTS_LIST = list(dict.fromkeys(list(map(get_artist, UPLOADED_LIST))))


# ×¤×•× ×§×¦×™×•×ª ×œ×§×™×¦×•×¨ ×“×¨×š, ×•×¡×™×“×•×¨ ×˜×§×¡×˜.
# ×× ×¡×” ×œ×©×œ×•×£ × ×ª×•× ×™× ×“×¨×š message, ×× ×œ× ××¦×œ×™×— ×× ×¡×” ×“×¨×š callback_query (×××¤×©×¨ ×©×™××•×© ×‘××•×ª×” ×¤×•× ×§×¦×™×” ×‘×©× ×™ ×”××§×¨×™×).
def get_message_chat_id(update):
    try:
        return update['message']['chat']['id']
    except KeyError:
        return update['callback_query']['message']['chat_id']


def get_message_id(update):
    try:
        return update['message']['message_id']
    except KeyError:
        return update['callback_query']['message']['message_id']


def get_message(update):
    try:
        return update['message']
    except KeyError:
        return update['callback_query']['message']


def get_message_from_id(update):
    try:
        return update['message']['from']['id']
    except KeyError:
        return update['callback_query']['from']['id']


def get_message_text(update):
    try:
        return update['message']['text']
    except KeyError:
        return update['callback_query']['data']


def get_query_id(update):
    return update["callback_query"]['id']


# ×”×¤×•× ×§×¦×™×” ×¨×¦×” ×‘×¨×§×¢, ×•×‘×•×“×§×ª ××ª×™ ×”×œ×™× ×§ ×©× ×©×œ×— ×‘×§×‘×•×¦×” × ×œ×—×¥.
# ×›×©×”×œ×™× ×§ × ×œ×—×¥, ××•×—×§×ª ××ª ×”×”×•×“×¢×•×ª ×©×”×‘×•×˜ ×©×œ×— ×‘×§×‘×•×¦×”, ×•××ª ×”×”×•×“×¢×•×ª ×œ×”×Ÿ ×”×•× ×”×’×™×‘.
def delete(time_hash):
    # ×× ××—×¨×™ 3 ×©×¢×•×ª (180 ×“×§', 36*300 ×©× ×™×•×ª) ×”×œ×™× ×§ ×¢×“×™×™×Ÿ ×œ× × ×œ×—×¥, ××•×—×§×™×  ××ª ×”×”×•×“×¢×•×ª ×‘×›×œ ×–××ª.
    for i in range(36):
        # ×× ×”×œ×™× ×§ × ×œ×—×¥, ×¦× ××”×œ×•×œ××”.
        if flags[time_hash]:
            break
        # ×× ×”×œ×™× ×§ ×œ× × ×œ×—×¥, ×—×›×” 5 ×“×§×•×ª ×•×‘×“×•×§ ×©×•×‘.
        time.sleep(300)

    # ××•×—×§ ××ª 2 ×”×”×•×“×¢×•×ª ××”×§×‘×•×¦×” - ×”×•×“×¢×ª ×”×‘×§×©×” ×•×”×•×“×¢×ª ×”×ª×’×•×‘×”.
    # ×‘×ª×•×š to_delete ×™×© ××ª ×”ID ×©×œ ×”×”×•×“×¢×”.
    bot.deleteMessage(to_delete[time_hash])
    bot.deleteMessage(to_delete[time_hash] + 1)


# ×™×•×¦×¨ ×¢×¨×š HASH ×‘××•×¨×š ××•×’×‘×œ ××”×˜×§×¡×˜ ×”× ×ª×•×Ÿ.
def h1(data):
    return hashlib.md5(data).hexdigest()[:9]


# ×”×¤×•× ×§×¦×™×” ×©×•×œ×—×ª ×”×•×“×¢×” ××—×ª (message) ×œ×›×œ ××©×ª××©×™ ×”×‘×•×˜.
# ×”×¤×•× ×§×¦×™×” ×’× ××¡×™×¨×” ××ª ×›×œ ×”××©×ª××©×™× ×©×—×¡××• ××ª ×”×‘×•×˜ \ ×œ× ×¤×¢×™×œ×™× × USERS.
# ×”×“×¨×š ×”×™×—×™×“×” (×”×™×“×•×¢×”) ×œ×‘×“×•×§ ××™ ××”××”×ª××©×™× ××›×Ÿ ×¤×¢×™×œ ×”×™× ×œ× ×¡×•×ª ×œ×©×œ×•×— ×œ×”× ×”×•×“×¢×”.
def msg(message):
    # ×¢×•×‘×¨ ×¢×œ ×›×œ ×”××©×ª××©×™×.
    for USER in USERS:

        # ×× ×”××©×ª××© ×—×¡× ××ª ×”×‘×•×˜, ×”×¤×¢×•×œ×” ×ª×—×–×™×¨ ×©×’×™××” (××©×ª××© ×œ× ×§×™×™× \ ×”×‘×•×˜ ×—×¡×•× ×•×›×“'
        try:
            # ×× ×¡×” ×œ×©×œ×•×— ××ª ×”×”×•×“×¢×” ×œ××©×ª××©.
            bot.sendMessage(chat_id=USER, text=message)

        # ×× ×™×© ×©×’×™××”, ×”××©×ª××© ×œ× ×¨×œ×•×•× ×˜×™.
        except Exception:

            # ××¡×™×¨×™× ××ª ×”××©×ª××© ××”×¨×©×™××”.
            USERS.remove(USER)
    # ×‘×’×œ×œ ×©×”×¨×©×™××” ×”×©×ª× ×ª×”, ×¦×¨×™×š ×œ×¢×“×›×Ÿ ××ª ×”×§×•×‘×¥.
    write_users()


# ××—×¨×™ ×©×”×¨×©×™××” ××ª×¢×“×›× ×ª ×•× ×•×¡×£ ××©×ª××©, ×¦×¨×™×š ×œ×¢×“×›×Ÿ ××ª ×”×§×•×‘×¥ ×©× ×©××¨ ×‘×¦×•×¨×” ×¡×˜××˜×™×ª ×•×œ× ×ª×œ×•×™ ×‘×ª×•×›× ×”.
def write_users():
    # ×¤×•×ª×— ××ª ×§×•×‘×¥ ×”××©×ª××©×™× ×œ×›×ª×™×‘×”.
    with open(USERS_PATH, 'w+') as out:
        # ×›×•×ª×‘×™× ××ª ×›×œ ×”××©×ª××©×™× ×¢× "\n" ×‘×™×Ÿ ××—×“ ×œ×©× ×™.
        out.write('\n'.join(USERS))
        out.close()


# ×©×•×œ×— ×©×™×¨ ××§×¨××™ ×œ××©×ª××©.
def send_random(update):
    # ×©×•×œ×£ ×©× ×©×œ ×©×™×¨ ×‘×¦×•×¨×” ××§×¨××™×ª.
    song_name = UPLOADED_LIST[randrange(len(UPLOADED_LIST))]

    # ×©×•×œ×— ××ª ×”×”×•×“×¢×” ×‘×¦×•×¨×” ××¡×•×“×¨×ª, ×›××™×œ×• ×–×• ×ª×•×¦××ª ×—×™×¤×•×© ×™×—×™×“×”.
    build_message([song_name], update)


# ×××™×¨ ××ª ×”×©×™×¨ ×œ×¡×•×œ× ×—×“×©
def new_key(index, key):
    # ×× ×××™×¨×™× ×‘1.5, ×–×” ×‘×¢×¦× 3 ×—×¦××™× ×œ×œ××¢×œ×”.
    # ×”×”××¨×” ×œ×¤×™ ×—×¦××™× ×›×™ ×™×•×ª×¨ ×§×œ ×œ×”×©×ª××© ×‘2 ×0.5
    half_key = int(float(key) * 2)

    # ×¤×•×ª×— ××ª ×”×§×•×‘×¥ ×”××§×•×¨×™ ×œ×§×¨×™××”.
    with open(UPLOADED_LIST[index], "r") as f:

        # ×§×•×¨× ××ª ×”×©×™×¨ ×œ×ª×•×š data.
        data = f.read()

        # ××—×“ ×“×™××–×™× ××—×“ ×‘××•×œ×™×
        for chord in CHORDS:

            # ×× ×¦×¨×™×š ×œ×”××™×¨ ×‘0 ×˜×•× ×™×, ××¤×©×¨ ×œ×“×œ×’ ×¢×œ ×”×”××¨×”.
            if key == 0:
                break

            if chord in LEVELS[0]:
                chord_index = LEVELS[0].index(chord)
                level = LEVELS[0]
            else:
                chord_index = LEVELS[1].index(chord)
                level = LEVELS[1]

            new_chord_index = half_key + chord_index
            len_level = len(level)

            if new_chord_index >= len_level:
                new_chord_index -= len_level

            if new_chord_index < 0:
                new_chord_index += len_level

            # ××—×œ×™×¤×™× ×œ××§×•×¨×“ ×”×‘×. ××•×¡×™×¤×™× | ×›×“×™ ×œ× ×œ×”××™×¨ ××ª ××•×ª×• ××—×“ ×¤×¢××™×™×.
            # //×× ×™×© ××§×•×¨×“ ×2 ×¡×•×’×™× (×œ×“×•×’' #G ×•×’× G) ×”××•×ª ×ª×§×‘×œ ×©×ª×™ ×”××¨×•×ª - ××—×ª ×’× ××”××§×•×¨×“ ×”××§×•×¨×™, ×•×œ×›×Ÿ ×¦×¨×™×š ×¨×©×™××” ××™×•×—×“×ª - ×©×‘×” ×”××§×•×¨×“×™× ×”××™×•×—×“×™× ××•×¤×™×¢×™× ×œ×¤× ×™ ×”×¨×’×™×œ×™×, ×•×›×š F# ××•×—×œ×¤×™× ×œ×¤× ×™ ×©×”×’×¢× ×• ×œ F.
            data = re.sub("\[" + chord, '[|' + str(level[new_chord_index]), data)

        # ×× ×”×©×¤×” ×”×™× ×¢×‘×¨×™×ª, ×¦×¨×™×š ×œ×”×•×¡×™×£ ×¡×™××Ÿ ××™×•×—×“ ××—×¨×™ ×”×›×•×›×‘×™×•×ª ×©×™×× ×¢ ××”×Ÿ ×œ×”×ª×”×¤×š ×‘×›×™×•×•×Ÿ.
        if data.split("\n")[5] == "HE":
            data = data.replace("#]", "#á¶¥")

        # ××•×—×§×™× ××ª ×›×œ ×”×¡×•×’×¨×™×™× ×©××¡×× ×™× ××§×•×¨×“ ××”×˜×§×¡×˜.
        data = data.replace("[|", "").replace("[", "").replace("]", "")

        # ××—×œ×§×™× ××ª ×”×˜×§×¡×˜ ×œ×©×•×¨×•×ª.
        data = data.split('\n')

        # ××¢×ª×™×§ ××ª ×”×¤×ª×™×—×” ×”×§×‘×•×¢×” ×œ×¢×•×ª×§ ××§×•××™, ×›×“×™ ×œ×©× ×•×ª ××•×ª×• ×‘×œ×™ ×œ×¤×ª×•×— ××—×“×© ××ª ×”×¦×•×¨×š.
        intro = INTRO

        # ××›× ×™×¡ ××ª ×©× ×”×©×™×¨ ×œ××§×•× ×”××ª××™× ×‘×¤×ª×™×—×”, ××¡×™×¨ ×ª×•×•×™× ××™×•×—×“×™× ×©×œ× ×§×™×™××™× ×‘×©× ×”×§×•×‘×¥.
        intro = intro.replace("song",
                              data[0].replace(" ", "_").replace('/', "").replace('&', "").replace("'", "").replace(
                                  ",", "_") + f"   \n{data[0]}")
        # ××›× ×™×¡ ××ª ×©× ×”×–××¨ ×œ××§×•× ×”××ª××™× ×‘×¤×ª×™×—×”, ××¡×™×¨ ×ª×•×•×™× ××™×•×—×“×™× ×©×œ× ×§×™×™××™× ×‘×©× ×”×§×•×‘×¥.
        intro = intro.replace("singer",
                              data[1].replace(" ", "_").replace('/', "").replace('&', "").replace("'", "").replace(
                                  ".", "_").replace(",", "_") + f"   \n{data[1]}")

        # ×× ×‘×©×•×¨×” ×”×©×œ×™×©×™×ª ×›×ª×•×‘ "×”××¢×¨×›×ª" ×•×œ× "×’×•×œ×©"..
        if "×”××¢×¨×›×ª" == data[2]:
            # ××•×¡×™×¤×™× ×œ×©×™×¨ ×¡×™××•×Ÿ ×©×œ ×’×¨×¡×” ×¨×©××™×ª.
            intro = intro.replace("version", "â­ï¸ ×’×¨×¡×” ×¨×©××™×ª â­")
        # ×× ×‘×©×•×¨×” ×”×©×œ×™×©×™×ª ×›×ª×•×‘ "×’×•×œ×©" ×•×œ× "×”××¢×¨×›×ª""..
        else:
            # ××•×—×§×™× ××ª ×”××™×§×•× ×©×œ ×”×’×¨×¡×” ×¨×©××™×ª.
            intro = intro.replace("version", "")

        # ×”×©×•×¨×” ×”×¨×‘×™×¢×™×ª ×‘×©×™×¨ ××›×™×œ×” ××ª ×”××¡×¤×¨ ×©×œ ×”×’×¨×¡×” ×”×§×œ×” - ×›××” ×¦×¨×™×š ×œ×”×–×™×– ×›×“×™ ×œ×”×’×™×¢ ××œ×™×”.
        # ×œ× ××›× ×™×¡×™× ××ª ×–×” ×œ×¤×ª×™×—×” ×›×™ ×œ××©×ª××© ×–×” ×œ× ×™×¢×™×œ, ××œ× ××¢×‘×™×¨×™× ×œ×¤×•× ×§×¦×™×” ×•×”×™× ××›× ×™×¡×” ××ª ×–×” ×œ× ×ª×•× ×™× ×©×œ ×›×¤×ª×•×¨ "×’×¨×¡×” ×§×œ×”".
        easy_key = data[3]

        # ××ª××™× ××ª ×”×§××¤×• ×œ×¡×•×œ× ×”×—×“×©.
        # ×¢×œ ×›×œ ×¢×œ×™×” ×‘×˜×•×Ÿ ×¦×¨×™×š ×œ×”×•×¨×™×“ ××ª ×”×§××¤×• ×‘×˜×•×Ÿ.
        capo = int(data[4]) - half_key

        # ××™×Ÿ ×§××¤×• ×‘×©×¨×™×’ ××¢×œ 12 - ×”×•× ×—×•×–×¨ ×œ××¤×¡.
        if capo >= 12:
            capo -= 12
        if capo < 0:
            capo += 12

        # ×‘×©×•×¨×” ×”×—××™×©×™×ª ×‘×©×™×¨ ×›×ª×•×‘ ××™×¤×” ×œ×©×™× ×§××¤×•. ×× ×”×§××¤×• ×‘×©×¨×™×’ 0..
        if 0 == capo:
            # ××¡×™×¨×™× ××ª ×”×¡×™××•×Ÿ ×©×œ ×”×§××¤×•. ×œ× ×¦×¨×™×š ×œ×¨×©×•× 0.
            intro = intro.replace("capo", "")
        # ×× ×”×§××¤×• ×‘×©×¨×™×’ ××—×¨..
        else:
            # ×¨×•×©××™× ×‘××™×§×•× ×”××ª××™× ××™×¤×” ×œ×©×™× ××ª ×”×§××¤×•.
            intro = intro.replace("capo", f"×§××¤×• ×‘×©×¨×™×’ {capo}")

        # ×”××™×“×¢ ×‘×ª×—×™×œ×ª ×”×©×™×¨ (×©××•×ª, ×§××¤×•, ×’×¨×¡×” ×§×œ×” ×•×›×“') ×œ× × ×©×œ×—, ×¨×§ × - data[5] ×•××™×œ×š.
        # ×•×œ×›×Ÿ ××•×¡×™×¤×™× ×œ- data[5] ××ª ×›×œ ×”×¤×ª×™×— ×”×¨×©××™, ×•×”×©×™×¨ × ×©×œ×— ××©× ×•××™×œ×š.
        data[5] = intro

        # ××•×¡×™×¤×™× ××ª ×”×¡×™×•××ª ×”×§×‘×•×¢×” (××™×Ÿ ×‘×” ××©×ª× ×™× ×‘×›×œ×œ).
        data.append(ENDING)

    # ×× ×§×™× ××ª ×¡×™×× ×™ ×”×‘×§×¨×”
    return data[5:], easy_key


# ×”×¤×•× ×§×¦×™×” ×©××˜×¤×œ×ª ×‘×”×•×“×¢×•×ª "START/", ×•××’×™×‘×” ×œ×”×Ÿ.
# ×™×© 2 ××•×¤×¦×™×•×ª ×œ×¤×§×•×“×ª START.
# ××• ××©×ª××© ×—×“×© (×•××– ×¦×¨×™×š ×œ×¨×©×•× ××•×ª×• ×•×œ×©×œ×•×— ×”×•×“×¢×ª ×‘×¨×•×š ×”×‘×)
# ××• ××©×ª××© ×©×”×’×™×¢ ××”×§×‘×•×¦×”, ×•×” START ×©×œ×• ××›×™×œ HASH ×œ×”×•×“×¢×” ×”××“×•×™×™×§×ª ×©×”×•× ×‘×™×§×©, ×•××– ×¦×¨×™×š ×œ×©×œ×•×— ×œ×• ××ª ×”×©×™×¨.
def start_handler(update):
    # ×¨×©×™××” ×©××›×™×œ×” ××ª ×›×œ ×” ID ×©×œ ×”××©×ª××©×™×.
    # ××©××©×ª ×œ×‘×“×™×§×” ×× ××“×•×‘×¨ ×‘×™×•×–×¨ ×¨×©×•× ××• ×©×¦×¨×™×š ×œ×”×•×¡×™×£ ××•×ª×•.
    global USERS

    # ×”×•×“×¢×•×ª ×‘×§×¨×” - ××ª×›× ×ª
    chat_id = get_message_chat_id(update)
    bot.sendMessage(chat_id=chat_id, text="start\n" + str(get_message_from_id(update)))
    bot.sendMessage(chat_id=chat_id, text="users\n" + str(get_message_from_id(update) in USERS))

    # ×× ××“×•×‘×¨ ×‘××©×ª××© ×—×“×©, ×¦×¨×™×š ×œ×”×•×¡×™×£ ××•×ª×• ×œ×¨×©×™××” ×•×œ×©××•×¨ ×œ×§×•×‘×¥.
    if get_message_from_id(update) not in USERS:
        # ××•×¡×™×£ ××ª ×”××©×ª××© ×œ×¨×©×™××”.
        USERS.append(get_message_from_id(update))

        # ×›×•×ª×‘ ××ª ×”×©×™× ×•×™×™× ×œ×§×•×‘×¥ ×©×œ× ×™×©×ª× ×” ×× ×”×ª×•×›× ×” ×ª×™×¤×•×œ.
        write_users()

        # ××¢×“×›×Ÿ ××ª ××ª×›× ×ª ×”×‘×•×˜ ×‘××¡×¤×¨ ×”××©×ª××©×™×.
        bot.sendMessage(chat_id=386848836, text=len(USERS))

        # ××“×•×‘×¨ ×‘××©×ª××© ×—×“×©. ×©×•×œ×— ×”×•×“×¢×ª "×‘×¨×•×š ×”×‘×" ××¡×•×“×¨×ª ×¢× ×”×•×¨××•×ª ×©×™××•×©.
        bot.sendMessage(chat_id=chat_id, text=
        '''×”×™×™, ×‘×¨×•×›×™× ×”×‘××™× ×œ×¨×•×‘×•×˜ ×”××§×•×¨×“×™× ×©×œ ğŸ¶â€ISRACHORDğŸ¶.\n
×©×™×œ×—×• ×©× ××œ× ××• ×—×œ×§×™ ×©×œ ×©×™×¨ *××•* ×××Ÿ, ×•×§×‘×œ×• ××ª ×”××§×•×¨×“×™×. ×›×Ÿ, ×›×–×” ×¤×©×•×˜.\n
×©×œ×—×• ×©× ×©×œ ××§×•×¨×“ (×œ××©×œ A#m) ×›×“×™ ×œ×§×‘×œ ××™×¦×‘×•×¢ ×œ×’×™×˜×¨×”.\n
×œ×“×™×•×•×—: @ADtmr\n
×”×¢×¨×•×¥ ×©×œ× ×•: @tab4us ''')
        return


# ×”×¤×•× ×§×¦×™×” ××˜×¤×œ×ª ×‘××§×¨×™× ×©×œ START ×¢× HASH - ××™×©×”×• ×§×™×‘×œ ×§×™×©×•×¨ ×œ×ª×•×¦××•×ª ××”×¨×•×‘×•×˜ ×‘×§×‘×•×¦×”, ×•×¢×›×©×™×• ×”×•× ××‘×§×© ××ª ×”×ª×•×¦××•×ª ×‘×”×•×“×¢×” ×¤×¨×˜×™×ª..
def start_hash_handler(update):
    # ××—×œ×¥ ××ª ×”ID ×©×œ ×”××©×ª××© ×•××ª ×” HASH ×©× ×•×¦×¨ ××•×˜×•××˜×™×ª (×¢"×¤ ×”×–××Ÿ ×‘×• × ×©×œ×—×” ×”×”×•×“×¢×”).
    time_hash, chat_id = get_message_text(update).replace("/start ", "").split("andand")

    # ××©× ×” ××ª ×”×“×’×œ ×©×œ ×” HASH ×œ TRUE - ××“×•×•×— ×©×”×§×™×©×•×¨ × ×œ×—×¥, ×•×›×š ×”×ª×•×›× ×” ×™×•×“×¢×ª ×œ××—×•×§ ××•×ª×•.
    flags[time_hash] = True

    # ×©×•×œ×£ ××ª ×”×ª×•×¦××•×ª (××•×¦× ×¢"×¤ ×” HASH) ×•×©×•××¨ ××•×ª×Ÿ ×œ files ×›××™×œ×• ×©×–×” ×—×™×¤×•×© ×©× ×¢×©×” ×¢×›×©×™×• ×‘×¤×¨×˜×™.
    files = saved[time_hash]

    # ××¤×¢×™×œ ××ª ×”×¤×•× ×§×¦×™×” ×©×©×•×œ×—×ª ××ª ×”×”×•×“×¢×” ×¢× ×”×ª×•×¦××•×ª.
    build_message(files, update)


# ×”×¤×•× ×§×¦×™×” ××§×‘×œ×ª ×ª×•×¦××•×ª ×—×™×¤×•×© (×¨×©×™××ª ×©××•×ª ×§×‘×¦×™×) ×•××—×–×™×¨×” ×”×•×“×¢×” ××ª××™××” / ×©×•×œ×—×ª ××ª ×”×ª×•×¦××” (×× ×™×© ×‘×•×“×“×ª)
def build_message(files, update):
    # × ×©××¨ ×œ×× ×•×¢ ×—×™×¤×•×© ×—×•×–×¨:
    #
    # ××¡×¤×¨ ×”×ª×•×¦××•×ª (×›××•×ª ×”×§×‘×¦×™× ×‘×¨×©×™××”)
    len_files = len(files)
    # ×”×˜×§×¡×˜ ×©×œ ×”×”×•×“×¢×” ×”××§×•×¨×™×ª.
    message = get_message_text(update)
    # ×”ID ×©×œ ×” CHAT.
    chat_id = get_message_chat_id(update)

    # ×× ×™×© ×ª×•×¦××•×ª ××‘×œ ×”×—×™×¤×•×© × ×¢×©×” ×‘×§×‘×•×¦×” ×•×œ× ×‘×¦'××˜ ×¤×¨×˜×™..
    if chat_id < 0 < len_files:

        # ×× ×™×© ××ª ×”××™×œ×” "××§×•×¨×“×™×" ×‘×”×•×“×¢×”, ××“×•×‘×¨ ×‘×—×™×¤×•×© ×•×œ× ×¡×ª× ×”×•×“×¢×” ×©×¨×¦×” ×¢× ×ª×•×¦××•×ª ×‘××§×¨×”.
        if "××§×•×¨×“×™×" in message:
            # ×™×•×¦×¨ HASH ×¢"×™ ×”×©×¢×” ×”××“×•×™×™×§×ª ×©× ×•×¢×“ ×œ×©××•×¨ ×•×œ×–×”×•×ª ××ª ×”××§×¨×” ×”×¡×¤×¦×™×¤×™ ×”×–×”.
            time_hash = h1(str(time.time()).encode())

            # ×©×•××¨ ×œ×ª×•×š ××™×œ×•×Ÿ ××ª ×ª×•×¦××•×ª, ×”××¤×ª×— ×”×•× ×” HASH (×›×©×”××©×ª××© ×™×—×–×•×¨, × ×•×›×œ ×œ×©×œ×•×£ ××ª ×”×ª×•×¦××•×ª ×‘×××¦×¢×•×ª ×” HASH ×‘×œ×‘×“).
            saved[time_hash] = files

            # ×™×•×¦×¨ ××§×œ×“×ª ××™×•×—×“×ª, ×©××•×‘×™×œ×” ×œ×ª×•×š ×”×‘×•×˜.
            # ×”×§×™×©×•×¨ ×”××™×•×—×“ ××¨××” ×›×¤×ª×•×¨ "×”×ª×—×œ" ×’× ×œ××©×ª××©×™× ×©×”×ª×—×™×œ×• ×›×‘×¨, ×•××–×™×Ÿ ×¢×¨×š ××™×•×—×“ ×œ start_hash_handler.
            replay_markup = InlineKeyboardMarkup([[
                InlineKeyboardButton(
                    # ×”×”×•×“×¢×” ×‘×§×‘×•×¦×” ×ª×”×™×” "××§×•×¨×“×™× ×¢×‘×•×¨ ___", ×•×¢×œ ×”×›×ª×¤×•×¨ ××ª×—×ª ×™×”×™×” ×›×ª×•×‘ "×œ×—×¥ ×¤×”".
                    text="×œ×—×¥ ×¤×”",

                    # ×œ×—×™×¦×” ×ª×•×‘×™×œ ×œ×§×™×©×•×¨ - ×¤×•×ª×— ××ª ×”×‘×•×˜, ×™×•×¦×¨ ×”×ª×—×œ×” ×—×“×©×” ×¢× ×” time_hash ×”××™×•×—×“ - ×•×›×š ×” start_hash_handler ×™×•×“×¢ ××™×–×” ×§×‘×¦×™× ×œ×”×¦×™×’.
                    url=f"https://t.me/Tab4usBot?start={str(time_hash)}andand{str(chat_id)}"
                )
            ]])

            # ××¡×“×¨ ××ª ×›×œ ×”×˜×§×¡×˜ ×›×“×™ ×œ×¨×©×•× ××ª ×”×©× ×©×œ ×”×©×™×¨ ×‘×¦×•×¨×” ××“×•×™×™×§×ª ×‘×”×•×“×¢×” ×”×—×•×–×¨×ª.
            data = message.replace("?", "")
            data = data.replace("×œ×©×™×¨ ", "×œ")
            data = data[data.index(" ×œ") + 2:]

            # ×©×•×œ×— ××ª ×”×”×•×“×¢×” ×¢× ×”××§×œ×“×ª.
            bot.sendMessage(text=f'××§×•×¨×“×™× ×œ "{data.replace("××§×•×¨×“×™× ", "")}"', chat_id=chat_id,
                            reply_markup=replay_markup)

            # ×©×•××¨ ×œ×ª×•×š ×¨×©×™××” ××™×•×—×“×ª ××™×–×• ×”×•×“×¢×” ×¦×¨×™×š ×œ××—×•×§ ×•×××™×¤×”.
            to_delete[time_hash] = [int(get_message_id(update))]

            # ×“×’×œ ×©×‘×•×“×§ ×× ×”×”×•×“×¢×” × ××—×§×”.
            flags[time_hash] = False

            # ×™×•×¦×¨ ×œ×•×œ××” ×©×¨×¦×” ×‘×¨×§×¢ ×•××•×—×§×ª ××ª ×”×”×•×“×¢×•×ª ×‘×§×‘×•×¦×” ××—×¨×™ ×©×”××©×ª××© ×œ×—×¥ ×¢×œ ×”×œ×™× ×§ (××•× ×¢ ×”×¡×¤××”)
            threading.Thread(target=delete, args=time_hash).start()
        return

    # ×× ××™×Ÿ ×ª×•×¦××•×ª..
    if len_files == 0:

        # ×× ×œ× ××“×•×‘×¨ ×‘×§×‘×•×¦×”, ×©×•×œ×—×™× ×”×•×“×¢×” ××•×˜×•××˜×™×ª ×©××“×•×•×—×ª ×¢×œ 0 ×ª×•×¦××•×ª. ×‘×§×‘×•×¦×•×ª ×œ×¨×•×‘ ×”×”×•×“×¢×•×ª ×œ× ×™×”×™×• ×ª×•×¦××•×ª, ×•×œ×›×Ÿ ×œ× ×©×•×œ×—×™× ×›×œ×•×.
        if chat_id > 0:
            # ×©×•×œ×— ×œ××©×ª××© ×©×œ× × ××¦××• ×ª×•×¦××•×ª.
            bot.sendMessage(chat_id=chat_id, text="×¤××“×™×—×”, ×œ× ××¦×× ×• ×›×œ×•×.. × ×¡×” ×©×™×œ×•×‘ ××—×¨!",
                            reply_markup=ReplyKeyboardRemove())
        return

    # ×× ×™×© ×›××” ×ª×•×¦××•×ª (×•×–×• ×œ× ×§×‘×•×¦×” ×›×™ ×§×‘×•×¦×” ×©×œ×œ× ×• ×œ××¢×œ×”)..
    if len_files > 1:

        # ××›×™×Ÿ ××§×œ×“×ª ×¢× ×›×œ ×”×ª×•×¦××•×ª.
        keyboard_values = sorted(list(map(replace_to_filename, files)))

        # ×”×˜×§×¡×˜ ×‘×”×•×“×¢×” ×”×•× "×‘×—×¨.."
        text = "×‘×—×¨.."

        # ×× ×™×© ××¢×œ 100 ×ª×•×¦××•×ª (×•×›×¤×ª×•×¨ ×—×–×•×¨ ××—×“) ××¦××¦××™× ×œ100 ×ª×•×¦××•×ª ×”×¨××©×•× ×•×ª - ×•×”××©×ª××© ×™×¦×˜×¨×š ×œ×“×™×™×§ ××ª ×”×—×™×¤×•×© ×©×œ×•.
        if len(files) > 100:
            # ×—×•×ª×›×™× ××ª ×”××§×œ×“×ª ×•××©××™×¨×™× ×¨×§ ××ª ×”178 ×¢×¨×›×™× ×”×¨××©×•× ×™×.
            keyboard_values = keyboard_values[:100]

            # ××“×•×•×—×™× ×œ××©×ª××© ×¢×œ ×¢×•×“×£ ×ª×•×¦××•×ª.
            text = "×”×—×™×¤×•×© ×©×œ×š ×›×•×œ×œ ×™×•×ª×¨ ××™×“×™ ×ª×•×¦××•×ª, ××– ×¦××¦×× ×• ×œ100 ×”×¨××©×•× ×™×.."

        # ××•×¡×™×¤×™× ×œ×ª×•×¦××•×ª ×›×¤×ª×•×¨ "×—×–×•×¨".
        keyboard_values.append("×—×–×•×¨")

        # ×™×•×¦×¨ ××§×œ×“×ª ×¢× ×”×ª×•×¦××•×ª ×”××ª××™××•×ª.
        keyboard = ReplyKeyboardMarkup(keyboard=[[i] for i in keyboard_values], resize_keyboard=True,
                                       one_time_keyboard=True)

        # ×©×•×œ×—×™× ×œ××©×ª××© ××ª ×”×”×•×“×¢×” ×¢× ××§×œ×“×ª ×”×ª×•×¦××•×ª.
        bot.sendMessage(chat_id=chat_id, text=text, reply_markup=keyboard)
        return

    # ×× ××’×™×¢×™× ×œ×¤×”, ×”××©××¢×•×ª ×”×™× ×©×™×¨ ××—×“ ×‘×¦'××˜ ×¤×¨×˜×™.

    # ××›× ×™×¡×™× ××ª ×”× ×ª×™×‘ ×œ×©×™×¨ ×œ××©×ª× ×” fpath.
    fpath = files[0]

    # ×¤×•×ª×—×™× ××ª ×”×§×•×‘×¥ ×©×œ ×”×©×™×¨ ×œ×§×¨×™××”.
    with open(fpath, "r") as song_file:

        # ×§×•×¨××™× ××ª ×›×œ ×”×§×•×‘×¥ ×œ×ª×•×š data.
        data = song_file.read()

        # ×× ×”×©×¤×” ×”×™× ×¢×‘×¨×™×ª, ×¦×¨×™×š ×œ×”×•×¡×™×£ ×¡×™××Ÿ ××™×•×—×“ ××—×¨×™ ×”×›×•×›×‘×™×•×ª ×©×™×× ×¢ ××”×Ÿ ×œ×”×ª×”×¤×š ×‘×›×™×•×•×Ÿ.
        if data.split("\n")[5] == "HE":
            data = data.replace("#]", "#á¶¥")

        # ××•×—×§×™× ××ª ×›×œ ×”×¡×•×’×¨×™×™× ×©××¡×× ×™× ××§×•×¨×“ ××”×˜×§×¡×˜.
        data = data.replace("[", "").replace("]", "")

        # ××—×œ×§×™× ××ª ×”×˜×§×¡×˜ ×œ×©×•×¨×•×ª.
        data = data.split('\n')

        # ××¢×ª×™×§ ××ª ×”×¤×ª×™×—×” ×”×§×‘×•×¢×” ×œ×¢×•×ª×§ ××§×•××™, ×›×“×™ ×œ×©× ×•×ª ××•×ª×• ×‘×œ×™ ×œ×¤×ª×•×— ××—×“×© ××ª ×”×¦×•×¨×š.
        intro = INTRO

        # ××›× ×™×¡ ××ª ×©× ×”×©×™×¨ ×œ××§×•× ×”××ª××™× ×‘×¤×ª×™×—×”, ××¡×™×¨ ×ª×•×•×™× ××™×•×—×“×™× ×©×œ× ×§×™×™××™× ×‘×©× ×”×§×•×‘×¥.
        intro = intro.replace("song",
                              data[0].replace(" ", "_").replace('/', "").replace('&', "").replace("'", "").replace(
                                  ",", "_") + f"   \n{data[0]}")
        # ××›× ×™×¡ ××ª ×©× ×”×–××¨ ×œ××§×•× ×”××ª××™× ×‘×¤×ª×™×—×”, ××¡×™×¨ ×ª×•×•×™× ××™×•×—×“×™× ×©×œ× ×§×™×™××™× ×‘×©× ×”×§×•×‘×¥.
        intro = intro.replace("singer",
                              data[1].replace(" ", "_").replace('/', "").replace('&', "").replace("'", "").replace(
                                  ".", "_").replace(",", "_") + f"   \n{data[1]}")

        # ×× ×‘×©×•×¨×” ×”×©×œ×™×©×™×ª ×›×ª×•×‘ "×”××¢×¨×›×ª" ×•×œ× "×’×•×œ×©"..
        if "×”××¢×¨×›×ª" == data[2]:
            # ××•×¡×™×¤×™× ×œ×©×™×¨ ×¡×™××•×Ÿ ×©×œ ×’×¨×¡×” ×¨×©××™×ª.
            intro = intro.replace("version", "â­ï¸ ×’×¨×¡×” ×¨×©××™×ª â­")
        # ×× ×‘×©×•×¨×” ×”×©×œ×™×©×™×ª ×›×ª×•×‘ "×’×•×œ×©" ×•×œ× "×”××¢×¨×›×ª""..
        else:
            # ××•×—×§×™× ××ª ×”××™×§×•× ×©×œ ×”×’×¨×¡×” ×¨×©××™×ª.
            intro = intro.replace("version", "")

        # ×”×©×•×¨×” ×”×¨×‘×™×¢×™×ª ×‘×©×™×¨ ××›×™×œ×” ××ª ×”××¡×¤×¨ ×©×œ ×”×’×¨×¡×” ×”×§×œ×” - ×›××” ×¦×¨×™×š ×œ×”×–×™×– ×›×“×™ ×œ×”×’×™×¢ ××œ×™×”.
        # ×œ× ××›× ×™×¡×™× ××ª ×–×” ×œ×¤×ª×™×—×” ×›×™ ×œ××©×ª××© ×–×” ×œ× ×™×¢×™×œ, ××œ× ××¢×‘×™×¨×™× ×œ×¤×•× ×§×¦×™×” ×•×”×™× ××›× ×™×¡×” ××ª ×–×” ×œ× ×ª×•× ×™× ×©×œ ×›×¤×ª×•×¨ "×’×¨×¡×” ×§×œ×”".
        easy_key = data[3]

        # ×‘×©×•×¨×” ×”×—××™×©×™×ª ×‘×©×™×¨ ×›×ª×•×‘ ××™×¤×” ×œ×©×™× ×§××¤×•. ×× ×”×§××¤×• ×‘×©×¨×™×’ 0..
        if "0" == data[4]:
            # ××¡×™×¨×™× ××ª ×”×¡×™××•×Ÿ ×©×œ ×”×§××¤×•. ×œ× ×¦×¨×™×š ×œ×¨×©×•× 0.
            intro = intro.replace("capo", "")
        # ×× ×”×§××¤×• ×‘×©×¨×™×’ ××—×¨..
        else:
            # ×¨×•×©××™× ×‘××™×§×•× ×”××ª××™× ××™×¤×” ×œ×©×™× ××ª ×”×§××¤×•.
            intro = intro.replace("capo", f"×§××¤×• ×‘×©×¨×™×’ {data[4]}")

        # ×”××™×“×¢ ×‘×ª×—×™×œ×ª ×”×©×™×¨ (×©××•×ª, ×§××¤×•, ×’×¨×¡×” ×§×œ×” ×•×›×“') ×œ× × ×©×œ×—, ×¨×§ × - data[5] ×•××™×œ×š.
        # ×•×œ×›×Ÿ ××•×¡×™×¤×™× ×œ- data[5] ××ª ×›×œ ×”×¤×ª×™×— ×”×¨×©××™, ×•×”×©×™×¨ × ×©×œ×— ××©× ×•××™×œ×š.
        data[5] = intro

        # ××•×¡×™×¤×™× ××ª ×”×¡×™×•××ª ×”×§×‘×•×¢×” (××™×Ÿ ×‘×” ××©×ª× ×™× ×‘×›×œ×œ).
        data.append(ENDING)

        # ×©×•×œ×—×™× ××ª ×”×©×™×¨ ×œ××©×ª××© ×‘×¢×–×¨×ª ×”×¤×•× ×§×¦×™×” ×”×™×™×¢×•×“×™×ª.
        send_data(data[5:], update, True, False, None, easy_key, UPLOADED_LIST.index(fpath))


# ×”×¤×•× ×§×¦×™×” ×©×•×œ×—×ª ××ª ×”×•×“×¢×” ×œ××©×ª××© ×‘×¦×•×¨×” ××¡×•×“×¨×ª.
def send_data(data, update, is_song=False, is_converted=False, keyboard=None, easy_key=None, file_index=None):
    # ×™×•×¦×¨ ××ª ×”××§×œ×“×ª ×›×œ ×¤×¢× ××—×“×©, ×›×™ ×”×¢×¨×š ×©×œ "×’×¨×¡×” ×§×œ×”" ×¦×¨×™×š ×œ×”×™×•×ª ×‘ callback_data.
    if keyboard is None:
        # ×× ×œ× ×‘×™×§×©×• ××§×œ×“×ª ×¡×¤×¦×™×¤×™×ª, ×™×•×¦×¨ ××ª ×”××§×œ×“×ª ×”×¨×’×™×œ×” ×¢× ×”×¢×¨×›×™× ×©×œ ××¡×¤×¨ ×”×©×™×¨ ×•×”×’×¨×¡×” ×§×œ×” ×©×œ×•.
        keyboard = default_keyboard(file_index, easy_key)

    # ×¨×©×™××” ×¨×™×§×” ×œ×ª×•×›×” ×ª×™×›× ×¡ ×”×”×•×“×¢×”, ×—×ª×•×›×” ×œ×¤×™ ×”×’×•×“×œ ×©×œ ×”×•×“×¢×” ××§×¡×™××œ×™×ª ×¢"×¤ ×˜×œ×’×¨× (×¢×“ 4096 ×ª×•×•×™× ×œ×”×•×“×¢×”).
    song = [""]

    # ××•× ×” - ×œ×›××” ×—×œ×§×™× ×”×ª×—×œ×§×” ×”×”×•×“×¢×”.
    counter = 0

    # ×¢×•×‘×¨ ×¢×œ ×”×©×™×¨ ×©×•×¨×” ×©×•×¨×”, ××•×¡×™×£ ×›×œ ×¤×¢× ××ª ×”×©×•×¨×” ×¢×“ ×©×”×’×•×“×œ ×—×•×¨×’, ×•××– ×¤×•×ª×— ×—×œ×§ ×©× ×™.
    for line in data:

        # ×©×•××¨ ××ª ×”×©×•×¨×” ×”× ×•×›×—×™×ª ×™×—×“ ×¢× ×”×©×•×¨×•×ª ×©× ×©××¨×• ×›×‘×¨ ×‘×—×ª×™×›×” ×”× ×•×›×—×™×ª ×©×œ song ×œ×ª×•×š test ×›×“×™ ×œ×‘×“×•×§ ×× ××—×¨×™ ×”×”×•×¡×¤×” ×”×’×•×“×œ ×™×—×¨×•×’.
        test = f"{song[counter]}%0A{line}{data[-1]}"

        # ×× ××—×¨×™ ×”×”×•×¡×¤×” ×”×’×•×“×œ ×—×•×¨×’ ×4096 ×‘×ª×™×..
        if len(test) >= 4096:
            # ××§×“× ××ª ×”××•× ×” ×‘1 ×›×™ ××•×¡×™×¤×™× ×—×œ×§ ×œ×©×™×¨.
            counter += 1
            # ×¤×•×ª×— ×—×ª×™×›×” ×—×“×©×” ×‘ song ×¢×‘×•×¨ ×”××©×š ×”×©×™×¨.
            song.append("")

        # ××—×¨×™ ×©× ×‘×“×§ ×œ××™×–×• ×—×ª×™×›×” ×¦×¨×™×›×” ×œ×”×™×›× ×¡ ×”×©×•×¨×” ×”× ×•×›×—×™×ª, ××•×¡×™×¤×™× ××ª ×”×©×•×¨×” ×œ song[counter] (×–×• ×”×—×ª×™×›×” ×”××ª××™××”).
        if is_song:
            # ×× ××“×•×‘×¨ ×‘×©×™×¨, ×¦×¨×™×š ×œ×”×•×¡×™×£ "×× ×˜×¨" ×‘×™×Ÿ ×©×•×¨×” ×œ×©×•×¨×”.
            song[counter] += f"\n{line}"
        else:
            # ×× ×œ× ××“×•×‘×¨ ×‘×©×™×¨, ×¤×©×•×˜ ××•×¡×™×¤×™× ××ª ×”×©×•×¨×” ×›××• ×©×”×™×.
            song[counter] += f"{line}"

    # ×¢×•×‘×¨ ×—×ª×™×›×” ×—×ª×™×›×” ×•×©×•×œ×— ×œ××©×ª××©.
    for part in song:
        # ×× ×–×• ×”×”×•×“×¢×” ×”××—×¨×•× ×”, ××•×¡×™×£ ××ª ×”××§×œ×“×ª.
        if part == song[-1]:
            reply_markup = keyboard

        else:
            # ×× ×–×• ×œ× ×”×”×•×“×¢×” ×”××—×¨×•× ×”, ××¡×™×¨ ××ª ×”××§×œ×“×ª.
            reply_markup = ReplyKeyboardRemove()

        # ×” -  ID ×©×œ ×§×‘×•×¦×” ×ª××™×“ ×™×”×™×” ×‘××™× ×•×¡.
        if get_message_chat_id(update) < 0:
            # ×× ×–×• ×”×•×“×¢×” ×‘×§×‘×•×¦×”, ××¡×™×¨ ××ª ×”××§×œ×“×ª.
            reply_markup = ReplyKeyboardRemove()

        # ×©×•×œ×— ××ª ×”×”×•×“×¢×” ×”××¡×•×“×¨×ª ×œ××©×ª××©.
        bot.sendMessage(chat_id=get_message_chat_id(update), text=part.replace(u'\xa0', u' '),
                        reply_markup=reply_markup)

    # ×¡××™×™×œ×™ ×™×“ ××¦×‘×™×¢ ×¢×œ ×”×”×•×“×¢×” ×”×¨××©×•× ×” ×›×“×™ ×œ×“×¤×“×£ ××œ×™×” ×‘×§×œ×•×ª.
    # ×× ××“×•×‘×¨ ×‘×”××¨×”, ×¦×¨×™×š ×œ×¨×“×ª ×¢×•×“ ×”×•×“×¢×” ××—×ª ×œ××˜×” (×”×”×•×“×¢×” ×©×”×•××¨×”, ×”×•×“×¢×ª ×”××¦×‘×¢ ×©×œ×”, ×•××– ×”×”×•×“×¢×” ×©× ×©×œ×—×” ×¢×›×©×™×•).
    bot.sendMessage(chat_id=get_message_chat_id(update), text=u'\u261d',
                    reply_to_message_id=get_message_id(update) + 1 + int(is_converted))


# ×”×¤×•× ×§×¦×™×” ××§×‘×œ×ª ×˜×§×¡×˜, ×•××—×¤×©×ª ×©××•×ª ×©×œ ×©×™×¨×™× ×©××›×™×œ×™× ××ª ×”×˜×§×¡×˜ ×”××‘×•×§×©.
def search_songs(update):
    # ×”×”×•×“×¢×” ×¢×¦××” ×©×”××©×ª××© ×©×œ×—.
    data = get_message_text(update)

    # ××’×“×™×¨×™× ×¤×¢× ××—×ª ×›×“×™ ×œ×—×¡×•×š ×©×™××•×© ×—×•×–×¨ ×‘×¤×•× ×§×¦×™×”.
    chat_id = get_message_chat_id(update)

    # ×× ××“×•×‘×¨ ×‘×§×‘×•×¦×”, ×¦×¨×™×š ×œ×”×•×¨×™×“ ×—×œ×§×™× ××™×•×ª×¨×™×.
    # ××ª "××§×•×¨×“×™×" ×•×›×“' ×›×‘×¨ ×”×¡×¨× ×• ×‘×¤×•× ×§×¦×™×” ×©×§×•×œ×˜×ª ××ª ×”×”×•×“×¢×”.
    if chat_id < 0:

        # ×‘×¡×•×£ ×‘×§×©×ª ×©×™×¨ ×”×¨×‘×” ×¤×¢××™× ×©××™× ×¡×™××Ÿ ×©××œ×” ××™×•×ª×¨.
        data = data.replace("?", "")

        # ×œ×¤×¢××™× ×‘×§×‘×•×¦×” ×›×•×ª×‘×™× "××§×•×¨×“×™× ×œ×©×™×¨..."
        # ×”×•×¤×›×™× ××ª ×–×” ×œ "××§×•×¨×“×™× ×œ...." ×›×“×™ ×©×”×—×™×ª×•×š ×‘×©×•×¨×” ×”×‘××” ×™×”×™×” ××“×•×™×™×§.
        data = data.replace("×œ×©×™×¨ ", "×œ")

        # ×—×•×ª×›×™× ××ª ×ª×—×™×œ×ª ×”×”×•×“×¢×” (××™×•×ª×¨. ×œ×“×•×’×× "×™×© ×œ××™×©×”×• ××§×•×¨×“×™× ×œ....")
        data = data[data.index(" ×œ") + 2:]

    # ×× ×”×”×•×“×¢×” × ×›×ª×‘×” ×¢"×™ ×”××ª×›× ×ª, ×”×™× ×œ× × ×›× ×¡×ª ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª.
    elif chat_id != 386848836:

        # ×× ×”×¢×¨×š ×›×‘×¨ × ××¦× ×‘××™×œ×•×Ÿ ×•×—×•×¤×© ×‘×¢×‘×¨..
        try:

            # ××•×¡×™×¤×™× 1 ×œ××•× ×” ×”×—×™×¤×•×©×™× ×©×œ×•.
            statistics[data] += 1

        # ×× ×–×” ×”×—×™×¤×•×© ×”×¨××©×•×Ÿ ×©×œ ×”×¢×¨×š..
        except KeyError:

            # ×™×•×¦×¨×™× ××ª ×”×¢×¨×š ×‘××™×œ×•×Ÿ, ×¢× ×”××•× ×” ×¢×œ ×”×¢×¨×š 1.
            statistics[data] = 1

        # ×‘×›×œ ××§×¨×” ×‘×¡×•×£ ×”×˜×™×¤×•×œ ×‘×¡×˜×˜×™×¡×˜×™×§×•×ª ×¦×¨×™×š ×œ×¢×“×›×Ÿ ××ª ×”×§×•×‘×¥.
        finally:

            # ×¤×•×ª×— ××ª ×”×§×•×‘×¥ ×©×©×•××¨ ××ª ×”×¡×˜×˜×™×¡×˜×™×§×•×ª..
            with open(STATISTICS_PATH, 'wb') as statistics_file:

                # ×©×•××¨ ××ª ×”× ×ª×•× ×™× ×”×—×“×©×™× ×œ×§×•×‘×¥.
                pickle.dump(statistics, statistics_file)

    # ×‘×¡×•×£ ×¨×©×™××ª ×©×™×¨×™× ×™×© ×œ××©×ª××© ×›×¤×ª×•×¨ "×—×–×•×¨".
    if data == "×—×–×•×¨":
        # ×× ×”××©×ª××© ×œ×—×¥ "×—×–×•×¨" ×”×‘×•×˜ ×©×•×œ×— ×œ×• ×”×•×“×¢×” "×—×•×–×¨" ×•××©× ×” ××ª ×”××§×œ×“×ª.
        bot.sendMessage(text="×—×•×–×¨..", chat_id=chat_id, reply_markup=random_keyboard)
        return

    # ×¨×©×™××” ×©×œ×ª×•×›×” ×™×™×©××¨×• ×ª×•×¦××•×ª ×”×—×™×¤×•×©.
    files = []

    # ×—×•×ª×š ××ª data ×œ2 ×—×œ×§×™× - ×©× ×”×©×™×¨ ×•×©× ×”×–××¨.
    # ××¢×‘×™×¨ ××•×ª× ×“×¨×š is_upper.
    # ×× ×”×©× ×œ× ××•×¨×›×‘ ×¨×§ ×××•×ª×™×•×ª ×’×“×•×œ×•×ª, ×”×•× ×¢×•×‘×¨ title ×›×“×™ ×œ×—×–×•×¨ ×œ××™×•×ª ×”× ×›×•×Ÿ.
    data = " - ".join(list(map(is_upper, data.split(' - '))))

    try:
        # ×× ×™×© ×‘×”×•×“×¢×” ×¡×™××Ÿ ×©×œ ' ×œ×¤× ×™ ×©× ×›×œ×©×”×•, title ×™×”×¤×•×š ××ª ×”××•×ª ××—×¨×™ ×œ×’×“×•×œ×” - ×œ××¨×•×ª ×©×”×™× ×œ× ×¦×¨×™×›×” ×œ×”×™×•×ª ×›×–×•.
        # ××—×¤×© ×× ×™×© ' ×‘×”×•×“×¢×”, ×•×× ×™×© ×”×•×¤×š ××ª ×”×ª×• ××—×¨×™ ×œ×”×™×•×ª ×§×˜×Ÿ.
        data = data.replace(data[data.index("'"):data.index("'") + 2],
                            data[data.index("'"):data.index("'") + 2].lower())
    # ×× ××™×Ÿ ' ×œ× ×¢×•×©×” ×›×œ×•×.
    except ValueError:
        pass

    # ×× ×¡×” ×œ×”×¨×›×™×‘ × ×ª×™×‘ ×œ×§×•×‘×¥ ×¢× ×”×”×•×“×¢×” ×”× ×•×›×—×™×ª ×‘×ª×•×¨ ×©× ×”×§×•×‘×¥.
    full_name = f"{UPLOADED_PATH}{data}.txt"

    # ×× ×”× ×ª×™×‘ ×§×™×™× ×•×™×© ×§×•×‘×¥ ×›×–×” (××™×©×”×• ×©×œ×— ×©× ××“×•×™×™×§ ×œ×§×•×‘×¥)..
    if full_name in UPLOADED_LIST:
        # ××›× ×™×¡ ×œ×ª×•×š files ××ª ×”× ×ª×™×‘ ×œ×§×•×‘×¥.
        files = [full_name]

        # ×‘×•× ×” ××ª ×”×”×•×“×¢×” ×¨×§ ×¢× ×”×§×•×‘×¥ ×”×–×”, ×›×ª×•×¦××ª ×—×™×¤×•×© ×™×—×™×“×”.
        build_message(files, update)
        return

    # ×× ×”×”×•×“×¢×” ×”×™× ×œ× ×©× ××œ× ×œ×§×•×‘×¥, ×¦×¨×™×š ×œ×—×¤×© ×œ××™×–×” ×§×‘×¦×™× ×”×™× ××ª××™××” ×—×œ×§×™×ª.
    for fpath in UPLOADED_LIST:

        # ×œ×¤×¢××™× ×” title ××—×–×™×¨ ×ª×•×¦××•×ª ×œ× ××“×•×™×™×§×•×ª (And ×‘××§×•× and ×•×›×“'), ×•×œ×›×Ÿ ×× ×™×© ×§×•×‘×¥ ×‘×¨×©×™××” ×©××—×¨×™ title ××ª××™× ×‘×“×™×•×§ ×œ×©×, ×©×•×œ×—×™× ××•×ª×•.
        if fpath.title() == full_name.title():
            # ××›× ×™×¡ ×œ×ª×•×š files ××ª ×”× ×ª×™×‘ ×œ×§×•×‘×¥.
            files = [fpath]

            # ×‘×•× ×” ××ª ×”×”×•×“×¢×” ×¨×§ ×¢× ×”×§×•×‘×¥ ×”×–×”, ×›×ª×•×¦××ª ×—×™×¤×•×© ×™×—×™×“×”.
            build_message(files, update)
            return

        # ×× ×”×©× ×©×œ ×”×©×™×¨ ××›×™×œ ××ª ×”×˜×§×¡×˜ ×©×œ ×”×”×•×“×¢×”, ××•×¡×™×¤×™× ××ª ×”×©×™×¨ ×›×ª×•×¦××ª ×—×™×¤×•×©.
        if data in fpath:
            files.append(fpath)

    # ××—×¨×™ ×—×™×¤×•×© ×‘×›×œ ×‘×©×™×¨×™×, ×‘×•× ×™× ×”×•×“×¢×” ××”×ª×•×¦××•×ª.
    build_message(files, update)
    return


# ×”×¤×•× ×§×¦×™×” ××˜×¤×œ×ª ×‘×œ×—×™×¦×•×ª ×›×¤×ª×•×¨ ×©×œ inline (×”××¨×ª ×¡×•×œ×).
def inline_button_handler(update):
    # ×©×•×œ×£ ××ª ×”×˜×§×¡×˜ ×©×œ ×”×›×¤×ª×•×¨ - callback_data.
    clicked = get_message_text(update)

    # ××—×œ×¥ ××ª ×”××™× ×“×§×¡ ×©×œ ×”×©×™×¨ - ××™×¤×” ×”×•× ×××•×§× ×‘ uploaded_list. ××©××© ×œ×”××¨×•×ª ×¢×¦××Ÿ - ×©×•×œ×¤×™× ××ª ×”×©×™×¨ ××”×§×•×‘×¥ ×”××§×•×¨×™, ×™×•×ª×¨ × ×— ×œ×”×ª×¢×¡×§ ××™×ª×•.
    index = clicked.split("|")[1]

    # ×”×ª×• ×”×¨××©×•×Ÿ ×”×•× ×¡×™××Ÿ "+" ××• "-". ×× ×”×ª×• ×”×©× ×™ ×”×•× "|" ××™×Ÿ ××¡×¤×¨, × ×œ×—×¥ ×›×¤×ª×•×¨ "+" ××• "-", ××” ×©××•××¨ ×©×¦×¨×™×š ×œ×¢×“×›×Ÿ ××ª ×”××§×œ×“×ª.
    if clicked[1] == "|":

        # ×× × ×œ×—×¥ ×›×¤×ª×•×¨ "+"..
        if clicked[0] == "+":

            try:
                # ×¢×•×¨×›×™× ××ª ×”××§×œ×“×ª ×©×œ ×”×”×•×“×¢×” ×”××ª××™××” - ×œ××§×œ×“×ª ×”××¨×” ×¢× ×›×¤×ª×•×¨×™ ×”"+".
                bot.editMessageReplyMarkup(telepot.message_identifier(get_message(update)),
                                           reply_markup=keyboard_plus(index))
            except Exception as e:
                print(e)

            finally:
                # ××“×•×•×— ×œ×˜×œ×’×¨× ×©×”×‘×§×©×” ×˜×•×¤×œ×” ×‘×”×¦×œ×—×”.
                bot.answerCallbackQuery(get_query_id(update))
                return

        # ×× × ×œ×—×¥ ×›×¤×ª×•×¨ "+"..
        elif clicked[0] == "-":

            try:
                # ×¢×•×¨×›×™× ××ª ×”××§×œ×“×ª ×©×œ ×”×”×•×“×¢×” ×”××ª××™××” - ×œ××§×œ×“×ª ×”××¨×” ×¢× ×›×¤×ª×•×¨×™ ×”"+".
                bot.editMessageReplyMarkup(
                    telepot.message_identifier(get_message(update)),
                    reply_markup=keyboard_minus(index))

            except Exception as e:
                print(e)

            finally:
                # ××“×•×•×— ×œ×˜×œ×’×¨× ×©×”×‘×§×©×” ×˜×•×¤×œ×” ×‘×”×¦×œ×—×”.
                bot.answerCallbackQuery(get_query_id(update))
                return

    # ×× ×”×›×¤×ª×•×¨ ×”×•× ×‘×§×©×” ×œ×”××¨×”, ×××™×¨ ××ª ×”×©×™×¨. ×©×•××¨ ×©×•×‘ ××ª easy_key ×›×™ ×¦×¨×™×š ××•×ª×• ×œ send_data ×›×“×™ ×œ×™×¦×•×¨ ××ª ×”××§×œ×“×ª ×”×¨×’×™×œ×”.
    data, easy_key = new_key(int(index), clicked.split("|")[0])

    # ×©×•×œ×— ××ª ×”×©×™×¨ ×”×—×“×© ××—×¨×™ ×”×”××¨×” ×œ××©×ª××©.
    send_data(data, update["callback_query"], True, True, None, easy_key, index)

    # ××“×•×•×— ×œ×˜×œ×’×¨× ×©×”×‘×§×©×” ×˜×•×¤×œ×” ×‘×”×¦×œ×—×”.
    bot.answerCallbackQuery(get_query_id(update))
    return


# ×”×¤×•× ×§×¦×™×” ×©××˜×¤×œ×ª ×‘×”×•×“×¢×•×ª ×˜×§×¡×˜, ×•××’×™×‘×” ×œ×”×Ÿ.
def message_handler(update):
    # ××©××© ×›×“×™ ×œ×”×›× ×™×¡ ××ª ×”×—×™×¤×•×© ×œ×¡×˜×˜×™×¡×˜×™×§×”.
    global statistics

    # ×”×˜×§×¡×˜ ×©×œ ×”×”×•×“×¢×”.
    message = get_message_text(update)

    # ×” ID ×©×œ ×”×¦'××˜ (×œ× ×©×œ ×”××©×ª××©).
    chat_id = get_message_chat_id(update)

    # ×× ×”××©×ª××© ×œ× ×‘×¨×©×™××” ×•×”×•× ×©×œ×— ×”×•×“×¢×”, ×¦×¨×™×š ×œ×”×•×¡×™×£ ××•×ª×•.
    if str(get_message_from_id(update)) not in USERS:
        # ××•×¡×™×£ ××ª ×”××©×ª××© ×œ×¨×©×™××”.
        USERS.append(str(get_message_from_id(update)))

        # ×›×•×ª×‘ ××ª ×”×©×™× ×•×™×™× ×œ×§×•×‘×¥ ×©×œ× ×™×©×ª× ×” ×× ×”×ª×•×›× ×” ×ª×™×¤×•×œ.
        write_users()

        # ××¢×“×›×Ÿ ××ª ××ª×›× ×ª ×”×‘×•×˜ ×‘××¡×¤×¨ ×”××©×ª××©×™×.
        bot.sendMessage(text=len(USERS), chat_id=386848836)

    # ×× ××“×•×‘×¨ ×‘×§×‘×•×¦×”, ×” ID ×ª××™×“ ×™×”×™×” ×§×˜×Ÿ ×0 (××ª×—×™×œ ×‘××™× ×•×¡, ×œ×“×•×’×× "-43452543642345" - ×œ×¢×•××ª ××©×ª××© ×©×™×”×™×” ×—×™×•×‘×™ (×œ×“×•×’××, "6453245734").
    if chat_id < 0:

        # ×× ×›×ª×•×‘ "××§×•×¨×“" ×•×œ× "××§×•×¨×“×™×", ×”×•× ×¨×•×¦×” ×ª××•× ×” ×©×œ ××§×•×¨×“.
        # ××•×—×§×™× ××ª ×”××™×œ×” "××§×•×¨×“" ×•×××©×™×›×™× ×›××• ×‘×©×™×—×” ×¨×’×™×œ×” (×”×‘×•×˜ ×™××¦× ××ª ×”×ª××•× ×” ×•×™×©×œ×— ×‘×§×‘×•×¦×”).
        if "××§×•×¨×“ " in message:
            message = message.replace("××§×•×¨×“ ", "")

        # ×× ××™×Ÿ ××ª ×”××™×œ×” "××§×•×¨×“", ×‘×•×“×§×™× ×× ×™×© "××§×•×¨×“×™×".
        else:

            # ×× ×™×© ×‘×”×•×“×¢×” ××ª ×”××™×œ×” "××§×•×¨×“×™×", ×”×•× ××—×¤×© ××§×•×¨×“×™× ×œ×©×™×¨. ×©×•×œ×—×™× ××ª ×”×˜×§×¡×˜ ×©×œ×• ×œ×—×™×¤×•×©.
            if "××§×•×¨×“×™×" in message:
                search_songs(update)
                return

            # ×× ××™×Ÿ "××§×•×¨×“×™×" ×•××™×Ÿ "××§×•×¨×“", ×–×• ×¡×ª× ×”×•×“×¢×” ×‘×§×‘×•×¦×”. ××ª×¢×œ××™× ××× ×”.
            else:
                return

    # ×× ×”ID ×”×•× ×©×œ ×”××ª×›× ×ª, ×™×© ×¤×§×•×“×•×ª ××™×•×—×“×•×ª ×©×”×•× ×™×›×•×œ ×œ×”×¨×™×¥.
    if chat_id == 386848836:

        # ×©×•×œ×— ××ª ×¨×©×™××ª ×”×¡×˜×˜×™×¡×˜×™×§×”, ×œ×¢×¨×›×™× ×©×—×•×¤×©×• ×”×—×œ ××¤×¢××™×™× (×™×•×ª×¨ ××™×“×™ ×¢×¨×›×™× ×—×•×¤×©×• ×¤×¢× ××—×ª)
        if message.title() == "St":
            # ×××™×™×Ÿ ××—×“×© ××ª statistics ×œ×§×¨××ª ×©×œ×™×—×”.
            statistics = collections.OrderedDict(sorted(statistics.items(), key=lambda kv: kv[20]))

            # ×©×•××¨ ×œ×ª×•×š str ××ª ×”× ×ª×•× ×™× ×‘×¤×•×¨××˜ × ×— ×œ×§×¨×™××”, ×•×¨×§ ××ª ×”×¢×¨×›×™× ×©×—×•×¤×©×• ×™×•×ª×¨ ××¤×¢× ××—×ª (×™×© ×™×•×ª×¨ ××™×“×™ ×›××œ×• ×©×—×•×¤×©×• ×¨×§ ×¤×¢× ××—×ª).
            statistics_to_send = [f"{k} : {v}\n" for k, v in statistics.items() if v > 10]

            # ×©×•×œ×— ××ª ×”× ×ª×•× ×™× ×œ××ª×›× ×ª.
            send_data(statistics_to_send, update)

            return

        # ×©×•×œ×— ××ª ××¡×¤×¨ ×”××©×ª××©×™× ×”×¢×“×›× ×™.
        if message.title() == "Cu":
            # ×©×•×œ×— ×œ××ª×›× ×ª ××ª ××¡×¤×¨ ×”××©×ª××©×™×.
            bot.sendMessage(text=str(len(USERS)), chat_id=chat_id)

            return

        # ×××¤×©×¨ ×œ××ª×›× ×ª ×œ×©×œ×•×— ×”×•×“×¢×” ×œ×›×œ×œ ×”××©×ª××©×™×.
        if "Msg" == message[:3].title():
            # ××¨×™×¥ ××ª ×”×¤×•× ×§×¦×™×” ×©×©×•×œ×—×ª, ×¢× ×”×˜×§×¡×˜ ×œ×©×œ×™×—×” (×”×›×œ ×—×•×¥ × "Msg ").
            msg(message[4:])

            return

        # ×©×•×œ×— ×œ××ª×›× ×ª ××ª ×¨×©×™××ª ×”×™×•×–×¨×™× (ID'S)
        if message.title() == "Usr":
            # ×©×•×œ×— ×“×¨×š ×”×¤×•× ×§×¦×™×”, ×›×™ ×œ×¤×¢××™× ×”×”×•×“×¢×” ××¨×•×›×” ××™×“×™ ×•×¦×¨×™×š ×œ×—×ª×•×š ××•×ª×” ×•×›×•'.
            send_data("\n".join(USERS), update)

            return

    # ×©×•×œ×— ×©×™×¨ ××§×¨××™ ×œ××©×ª××©.
    if message == "×©×™×¨ ××§×¨××™":
        # ××¤×¢×™×œ ×¤×•× ×§×¦×™×” ×©×©×•×œ×—×ª ×©×™×¨ ××§×¨××™ ×œ××©×ª××©.
        send_random(update)

        return

    # ×× ××™×©×”×• ×¨×•×¦×” ××ª ×¨×©×™××ª ×”×–××¨×™×, ×”×•× ×©×•×œ×— "×¨×©×™××ª ××× ×™×" ×•××§×‘×œ ××ª ×”×¨×©×™××”.
    if "×¨×©×™××ª ××× ×™×" in message:
        # ×”×ª×•×¦××•×ª ×”×Ÿ ×¨×©×™××ª ×”××× ×™× ×—×ª×•×›×” - ×©×•×¨×” ×—×“×©×” ×œ×›×œ ×©×.
        result = '\n'.join(ARTISTS_LIST)

        # ×©×•×œ×— ×“×¨×š ×”×¤×•× ×§×¦×™×” ×›×™ ×œ×¤×¢××™× ×”×”×•×“×¢×” ××¨×•×›×” ××™×“×™.
        send_data(result, update)

        return

    # ××‘×¦×¢ ×˜×™×™×˜×œ ×œ×”×•×“×¢×” - ×§×•×“× ×›×œ ××–×™×– ××ª ×”×ª×•×•×™× ×©×™×›×•×œ×™× ×œ×”×¤×¨×™×¢ ×”×¦×™×“×” ( "_" ×œ×¤× ×™ ×ª×—×™×œ×ª ××™×œ×” ××• "#"), ××‘×¦×¢ title (×©××•×ª ×”×©×™×¨×™× ×‘×§×•×‘×¥ ×”× ×‘×˜×™×™×˜×œ - ××•×ª ×¨××©×•× ×” ×’×“×•×œ×”) ×•××—×–×™×¨ ××ª ×”×¡×™×× ×™× ×”××§×•×¨×™×™×.
    # ×œ×¤×¢××™× ××‘×§×©×™× ××§×•×¨×“ ×•×¨×•×¦×™× ×ª××•× ×” ×©×œ×•, ××‘×œ ×™×© ××§×•×¨×“×™× ×¢× ×©× ×™ ×©××•×ª - ×•×œ×›×Ÿ ××—×œ×™×¤×™× ××ª ×”××§×•×¨×“ ×œ×©× ×”×§×‘×™×œ ×¢× ×”×ª××•× ×” (×œ×“×•×’×× ×™×© ×ª××•× ×” ×¨×§ ×œ"Eb", ×•×œ×›×Ÿ ××—×œ×™×¤×™× ××ª "D#" ×œ×”×™×•×ª "Eb" - ××•×ª×• ××§×•×¨×“ ×‘×©××•×ª ×©×•× ×™×).
    chord = message.replace("_", "_ ").replace("#", "# P").title().replace("_ ", "_").replace("# P", "#").replace("/",
                                                                                                                  "_").replace(
        "\\", "_").replace("A#", "Bb") \
        .replace("Db", "C#").replace("D#", "Eb").replace("Gb", "F#").replace("G#", "Ab")

    # ×× ×”×˜×§×¡×˜ × ××¦× ×‘×¡×¤×¨×™×™×ª ×”××§×•×¨×“×™×, ×”×•× ××§×•×¨×“ ×•×”×©×•×œ×— ×¨×•×¦×” ×œ×§×‘×œ ×—×–×¨×” ×ª××•× ×”.
    if chord in CHORDS_LIBRARY:

        # ×©×•×œ×— ××ª ×”×ª××•× ×” ×©×œ ×”××§×•×¨×“.
        bot.sendPhoto(caption=message.replace("_", "/"),
                      chat_id=chat_id,
                      photo=open(f'{ROOT_PATH}/chords/{chord}.png', 'rb'))

        return

    # ×× ×”×˜×§×¡×˜ ×”×•× ×œ× ××§×•×¨×“, ×”×•× ×©×™×¨ ×•×¦×¨×™×š ×œ×—×¤×© ××•×ª×•.
    else:

        # ××¨×™×¥ ××ª ×”×¤×•× ×§×¦×™×” ×©××—×¤×©×ª ×©×™×¨×™×.
        search_songs(update)
    return


# ××’×“×™×¨×™× ×œ××” ×”××©×™××” ×ª×¢× ×”: ×¤× ×™×•×ª ××¡×•×’ POST ×œ×›×ª×•×‘×ª ×”×¡×¤×¦×™×¤×™×ª ×”×–×•.
@app.route(f'/{BOT_TOKEN}', methods=["POST"])
def main_handler():
    # ××©× ×” ××ª ×”×§×™×“×•×“. ×”×¢×“×›×•×Ÿ ××ª×§×‘×œ ×‘×§×™×“×•×“ JSON. ××—×œ×™×£ ××ª ×”×§×™×“×•×“ ×œ×”×™×•×ª dict ×©×œ python
    update = request.get_json()

    # ××“×¤×™×¡ ××ª ×”×©×¢×” ×œ×¤×™ ×©×¢×•×Ÿ ×™×©×¨××œ ×•××ª ×”×”×•×“×¢×” ×›×œ ×¤×¢× ×©××ª×§×‘×œ×ª ×”×•×“×¢×”.
    print("\n", str(datetime.now(timezone("Israel")))[:-13], "\n")

    # ×× ××“×•×‘×¨ ×‘×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨, ×”×¤×•×¨××˜ ×©×™×ª×§×‘×œ ×™×”×™×” ×©×•× ×”. ×©×•×œ×—×™× ××ª ×”××™×“×¢ ×œ×¤×•× ×§×¦×™×” ×”×™×¢×•×“×™×ª.
    if 'callback_query' in update:
        inline_button_handler(update)
        return "OK"

    # ×©×•××¨×™× ××ª chat_id ×¤×¢× ××—×ª ×›×“×™ ×œ×—×¡×•×š ××©××‘×™×.
    chat_id = get_message_chat_id(update)

    # ×‘×•×“×§×™× ×× ×™×© ×˜×§×¡×˜ ×‘×”×•×“×¢×”:
    try:
        # ×× ×¡×™× ×œ×”×›× ×™×¡ ××ª ×”×˜×§×¡×˜ ××”×”×•×“×¢×” ×œ×ª×•×š message.
        message = get_message_text(update)

    # ×× ××ª×§×‘×œ KeyError ××™×Ÿ ×˜×§×¡×˜ ×‘×”×•×“×¢×”.
    except KeyError:
        # ×× ××™×Ÿ ×˜×§×¡×˜ ×‘×”×•×“×¢×”, ××ª×¢×œ××™× ××× ×”. ×”×™× ×—×¡×¨×ª ××©××¢×•×ª ×¢×‘×•×¨ ×”×‘×•×˜.
        bot.sendMessage(text="×”×‘×•×˜ ××˜×¤×œ ×¨×§ ×‘×”×•×“×¢×•×ª ×˜×§×¡×˜. \n ×©×œ×— ×”×•×“×¢×” ×¢× ×©× ×©×œ ×©×™×¨ *××•* ×©×œ ×–××¨.", chat_id=chat_id)
        return "OK"

    # ×× ×–×• ×”×•×“×¢×ª "/start" ×”×™× ×œ× ×“×•×¨×©×ª ×ª×’×•×‘×” ×¢× ×™×™× ×™×ª ×œ×˜×§×¡×˜, ××œ× ×ª×—×™×œ×ª ×¢×‘×•×“×”.
    if message == "/start":
        # ×©×•×œ×— ××ª ×”× ×ª×•× ×™× (update) ×œ×¤×•× ×§×¦×™×” ×©××˜×¤×œ×ª  ×‘ START ×•××¡×™×™× ××ª ×”×¤×¢×•×œ×”.
        start_handler(update)
        return "OK"

    # ×× ×”×”×•×“×¢×” ×”×™× /start ××‘×œ ×™×© ×‘×” ×¢×•×“ ×˜×§×¡×˜, ××“×•×‘×¨ ×‘ /start ×¢× HASH.
    elif "/start" in message:
        # ××¨×™×¥ ××ª ×”×¤×•× ×§×¦×™×” ×¢× ×” HASH ×›×“×™ ×œ×˜×¤×œ ×‘×”×•×“×¢×”.
        start_hash_handler(update)
        return "OK"

    # ×× ×™×© ×˜×§×¡×˜ ×•×”×•× ×œ× START , ×¦×¨×™×š ×œ×—×¤×© ××ª ×”×©×™×¨ ×”××ª××™× ×•×›×“' - ×©×•×œ×— ××ª ×”× ×ª×•× ×™× (update) ×œ×¤×•× ×§×¦×™×” ×©××˜×¤×œ×ª ×‘×”×•×“×¢×•×ª.
    message_handler(update)

    return "OK"
